(function(h){function n(a,b){var d=typeof a[b];return"function"==d||!("object"!=d||!a[b])||"unknown"==d}function r(a,b){return!("object"!=typeof a[b]||!a[b])}function g(a,b){return"undefined"!=typeof a[b]}function l(a){return function(b,d){for(var e=d.length;e--;)if(!a(b,d[e]))return!1;return!0}}function c(a){return a&&G(a,m)&&p(a,z)}function v(a){return r(a,"body")?a.body:a.getElementsByTagName("body")[0]}function y(a){r(window,"console")&&n(window.console,"log")&&window.console.log(a)}function w(a){t.initialized=
!0;t.supported=!1;a="Rangy is not supported on this page in your browser. Reason: "+a;t.config.alertOnFail?window.alert(a):y(a)}function D(){if(!t.initialized){var a,d=!1,f=!1;n(document,"createRange")&&(a=document.createRange(),G(a,k)&&p(a,e)&&(d=!0));if((a=v(document))&&"body"==a.nodeName.toLowerCase())if(a&&n(a,"createTextRange")&&(a=a.createTextRange(),c(a)&&(f=!0)),d||f){t.initialized=!0;t.features={implementsDomRange:d,implementsTextRange:f};var m,z;for(z in B)(m=B[z])instanceof b&&m.init(m,
t);f=0;for(m=M.length;f<m;++f)try{M[f](t)}catch(g){d="Rangy init listener threw an exception. Continuing. Detail: "+(g.message||g.description||String(g)),y(d)}}else w("Neither Range nor TextRange are available");else w("No body element found")}}function b(a,b,d){this.name=a;this.dependencies=b;this.supported=this.initialized=!1;this.initializer=d}function f(a,d,e,k){a=new b(d,e,function(a){if(!a.initialized){a.initialized=!0;try{k(t,a),a.supported=!0}catch(b){y("Module '"+d+"' failed to load: "+(b.message||
b.description||String(b)))}}});B[d]=a}function a(){}var d="function"==typeof h.define&&h.define.amd,e="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" "),k="setStart setStartBefore setStartAfter setEnd setEndBefore setEndAfter collapse selectNode selectNodeContents compareBoundaryPoints deleteContents extractContents cloneContents insertNode surroundContents cloneRange toString detach".split(" "),z="boundingHeight boundingLeft boundingTop boundingWidth htmlText text".split(" "),
m="collapse compareEndPoints duplicate moveToElementText parentElement select setEndPoint getBoundingClientRect".split(" "),G=l(n),q=l(r),p=l(g),B={},t={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:n,isHostObject:r,isHostProperty:g,areHostMethods:G,areHostObjects:q,areHostProperties:p,isTextRange:c,getBody:v},features:{},modules:B,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};t.fail=w;t.warn=function(a){a="Rangy warning: "+a;t.config.alertOnWarn?window.alert(a):
y(a)};({}).hasOwnProperty?t.util.extend=function(a,b,d){var e,k,c;for(c in b)b.hasOwnProperty(c)&&(e=a[c],k=b[c],d&&null!==e&&"object"==typeof e&&null!==k&&"object"==typeof k&&t.util.extend(e,k,!0),a[c]=k);b.hasOwnProperty("toString")&&(a.toString=b.toString);return a}:w("hasOwnProperty not supported");(function(){var a=document.createElement("div");a.appendChild(document.createElement("span"));var b=[].slice,d;try{1==b.call(a.childNodes,0)[0].nodeType&&(d=function(a){return b.call(a,0)})}catch(e){}d||
(d=function(a){for(var b=[],d=0,e=a.length;d<e;++d)b[d]=a[d];return b});t.util.toArray=d})();var I;n(document,"addEventListener")?I=function(a,b,d){a.addEventListener(b,d,!1)}:n(document,"attachEvent")?I=function(a,b,d){a.attachEvent("on"+b,d)}:w("Document does not have required addEventListener or attachEvent method");t.util.addListener=I;var M=[];t.init=D;t.addInitListener=function(a){t.initialized?a(t):M.push(a)};var A=[];t.addCreateMissingNativeApiListener=function(a){A.push(a)};t.createMissingNativeApi=
function(a){a=a||window;D();for(var b=0,d=A.length;b<d;++b)A[b](a)};b.prototype={init:function(a){a=this.dependencies||[];for(var d=0,e=a.length,k,c;d<e;++d){c=a[d];k=B[c];if(!(k&&k instanceof b))throw Error("required module '"+c+"' not found");k.init();if(!k.supported)throw Error("required module '"+c+"' not supported");}this.initializer(this)},fail:function(a){this.initialized=!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+a);},warn:function(a){t.warn("Module "+this.name+
": "+a)},deprecationNotice:function(a,b){t.warn("DEPRECATED: "+a+" in module "+this.name+"is deprecated. Please use "+b+" instead")},createError:function(a){return Error("Error in Rangy "+this.name+" module: "+a)}};t.createModule=function(a){var b,d;2==arguments.length?(b=arguments[1],d=[]):(b=arguments[2],d=arguments[1]);f(!1,a,d,b)};t.createCoreModule=function(a,b,d){f(!0,a,b,d)};t.RangePrototype=a;t.rangePrototype=new a;t.selectionPrototype=new function(){};var Q=!1,q=function(a){Q||(Q=!0,t.initialized||
D())};"undefined"==typeof window?w("No window found"):"undefined"==typeof document?w("No document found"):(n(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",q,!1),I(window,"load",q),d&&function(a){a(function(){t.amd=!0;return t})}(h.define),h.rangy=t)})(this);
rangy.createCoreModule("DomUtil",[],function(h,n){function r(a){for(var b=0;a=a.previousSibling;)++b;return b}function g(a,b){var d=[],e;for(e=a;e;e=e.parentNode)d.push(e);for(e=b;e;e=e.parentNode)if(G(d,e))return e;return null}function l(a,b,d){for(b=d?b:b.parentNode;b;){if(b===a)return!0;b=b.parentNode}return!1}function c(a,b,d){for(d=d?a:a.parentNode;d;){a=d.parentNode;if(a===b)return d;d=a}return null}function v(a){a=a.nodeType;return 3==a||4==a||8==a}function y(a,b){var d=b.nextSibling,e=b.parentNode;
d?e.insertBefore(a,d):e.appendChild(a);return a}function w(a){if(9==a.nodeType)return a;if("undefined"!=typeof a.ownerDocument)return a.ownerDocument;if("undefined"!=typeof a.document)return a.document;if(a.parentNode)return w(a.parentNode);throw n.createError("getDocument: no document found for node");}function D(a){a=w(a);if("undefined"!=typeof a.defaultView)return a.defaultView;if("undefined"!=typeof a.parentWindow)return a.parentWindow;throw n.createError("Cannot get a window object for node");
}function b(a){if("undefined"!=typeof a.contentDocument)return a.contentDocument;if("undefined"!=typeof a.contentWindow)return a.contentWindow.document;throw n.createError("getIframeDocument: No Document object found for iframe element");}function f(a){return a&&z.isHostMethod(a,"setTimeout")&&z.isHostObject(a,"document")}function a(a){return a?v(a)?'"'+a.data+'"':1==a.nodeType?"\x3c"+a.nodeName+(a.id?' id\x3d"'+a.id+'"':"")+"\x3e[index:"+r(a)+",length:"+a.childNodes.length+"]["+(a.innerHTML||"[innerHTML not supported]").slice(0,
25)+"]":a.nodeName:"[No node]"}function d(a){this._next=this.root=a}function e(a,b){this.node=a;this.offset=b}function k(a){this.code=this[a];this.codeName=a;this.message="DOMException: "+this.codeName}var z=h.util;z.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||n.fail("document missing a Node creation method");z.isHostMethod(document,"getElementsByTagName")||n.fail("document missing getElementsByTagName method");var m=document.createElement("div");z.areHostMethods(m,
["insertBefore","appendChild","cloneNode"])||n.fail("Incomplete Element implementation");z.isHostProperty(m,"innerHTML")||n.fail("Element is missing innerHTML property");m=document.createTextNode("test");z.areHostMethods(m,["splitText","deleteData","insertData","appendData","cloneNode"])||n.fail("Incomplete Text Node implementation");var G=function(a,b){for(var d=a.length;d--;)if(a[d]===b)return!0;return!1},q=!1;(function(){var a=document.createElement("b");a.innerHTML="1";a.innerHTML="\x3cbr\x3e";
q=!1;h.features.crashyTextNodes=q})();var p;"undefined"!=typeof window.getComputedStyle?p=function(a,b){return D(a).getComputedStyle(a,null)[b]}:"undefined"!=typeof document.documentElement.currentStyle?p=function(a,b){return a.currentStyle[b]}:n.fail("No means of obtaining computed style properties found");d.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next,b;if(this._current){b=a.firstChild;if(!b)for(b=null;a!==this.root&&!(b=a.nextSibling);)a=
a.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}};e.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},inspect:function(){return"[DomPosition("+a(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};k.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24};
k.prototype.toString=function(){return this.message};h.dom={arrayContains:G,isHtmlNamespace:function(a){var b;return"undefined"==typeof a.namespaceURI||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b},parentElement:function(a){a=a.parentNode;return 1==a.nodeType?a:null},getNodeIndex:r,getNodeLength:function(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}},getCommonAncestor:g,isAncestorOf:l,isOrIsAncestorOf:function(a,b){return l(a,
b,!0)},getClosestAncestorIn:c,isCharacterDataNode:v,isTextOrCommentNode:function(a){if(!a)return!1;a=a.nodeType;return 3==a||8==a},insertAfter:y,splitDataNode:function(a,b,d){var e=a.cloneNode(!1);e.deleteData(0,b);a.deleteData(b,a.length-b);y(e,a);if(d)for(var k=0,c;c=d[k++];)c.node==a&&c.offset>b?(c.node=e,c.offset-=b):c.node==a.parentNode&&c.offset>r(a)&&++c.offset;return e},getDocument:w,getWindow:D,getIframeWindow:function(a){if("undefined"!=typeof a.contentWindow)return a.contentWindow;if("undefined"!=
typeof a.contentDocument)return a.contentDocument.defaultView;throw n.createError("getIframeWindow: No Window object found for iframe element");},getIframeDocument:b,getBody:z.getBody,isWindow:f,getContentDocument:function(a,d,e){var k;a?z.isHostProperty(a,"nodeType")?k=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?b(a):w(a):f(a)&&(k=a.document):k=document;if(!k)throw d.createError(e+"(): Parameter must be a Window object or DOM node");return k},getRootContainer:function(a){for(var b;b=a.parentNode;)a=
b;return a},comparePoints:function(a,b,d,e){var k;if(a==d)return b===e?0:b<e?-1:1;if(k=c(d,a,!0))return b<=r(k)?-1:1;if(k=c(a,d,!0))return r(k)<e?-1:1;b=g(a,d);if(!b)throw Error("comparePoints error: nodes have no common ancestor");a=a===b?b:c(a,b,!0);d=d===b?b:c(d,b,!0);if(a===d)throw n.createError("comparePoints got to case 4 and childA and childB are the same!");for(b=b.firstChild;b;){if(b===a)return-1;if(b===d)return 1;b=b.nextSibling}},isBrokenNode:function(a){return!1},inspectNode:a,getComputedStyleProperty:p,
fragmentFromNodeChildren:function(a){for(var b=w(a).createDocumentFragment(),d;d=a.firstChild;)b.appendChild(d);return b},createIterator:function(a){return new d(a)},DomPosition:e};h.DOMException=k});
rangy.createCoreModule("DomRange",["DomUtil"],function(h,n){function r(a,b){return 3!=a.nodeType&&(R(a,b.startContainer)||R(a,b.endContainer))}function g(a){return a.document||Y(a.startContainer)}function l(a){return new U(a.parentNode,J(a))}function c(a){return new U(a.parentNode,J(a)+1)}function v(a,b,d){var e=11==a.nodeType?a.firstChild:a;u(b)?d==b.length?x.insertAfter(a,b):b.parentNode.insertBefore(a,0==d?b:ba(b,d)):d>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[d]);return e}
function y(a,b,d){A(a);A(b);if(g(b)!=g(a))throw new H("WRONG_DOCUMENT_ERR");var e=E(a.startContainer,a.startOffset,b.endContainer,b.endOffset);a=E(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return d?0>=e&&0<=a:0>e&&0<a}function w(a){for(var b,d,e=g(a.range).createDocumentFragment();d=a.next();){b=a.isPartiallySelectedSubtree();d=d.cloneNode(!b);b&&(b=a.getSubtreeIterator(),d.appendChild(w(b)),b.detach());if(10==d.nodeType)throw new H("HIERARCHY_REQUEST_ERR");e.appendChild(d)}return e}
function D(a,b,d){var e,k;for(d=d||{stop:!1};e=a.next();)if(a.isPartiallySelectedSubtree())if(!1===b(e)){d.stop=!0;break}else{if(e=a.getSubtreeIterator(),D(e,b,d),e.detach(),d.stop)break}else for(e=x.createIterator(e);k=e.next();)if(!1===b(k)){d.stop=!0;return}}function b(a){for(var d;a.next();)a.isPartiallySelectedSubtree()?(d=a.getSubtreeIterator(),b(d),d.detach()):a.remove()}function f(a){for(var b,d=g(a.range).createDocumentFragment(),e;b=a.next();){a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),
e=a.getSubtreeIterator(),b.appendChild(f(e)),e.detach()):a.remove();if(10==b.nodeType)throw new H("HIERARCHY_REQUEST_ERR");d.appendChild(b)}return d}function a(a,b,d){var k=!(!b||!b.length),c,C=!!d;k&&(c=new RegExp("^("+b.join("|")+")$"));var f=[];D(new e(a,!1),function(b){if(!k||c.test(b.nodeType))if(!C||d(b)){var e=a.startContainer;b==e&&u(e)&&a.startOffset==e.length||(e=a.endContainer,b==e&&u(e)&&0==a.endOffset||f.push(b))}});return f}function d(a){return"["+("undefined"==typeof a.getName?"Range":
a.getName())+"("+x.inspectNode(a.startContainer)+":"+a.startOffset+", "+x.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function e(a,b){this.range=a;this.clonePartiallySelectedTextNodes=b;if(!a.collapsed){this.sc=a.startContainer;this.so=a.startOffset;this.ec=a.endContainer;this.eo=a.endOffset;var d=a.commonAncestorContainer;this.sc===this.ec&&u(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==d||u(this.sc)?V(this.sc,d,!0):
this.sc.childNodes[this.so],this._last=this.ec!==d||u(this.ec)?V(this.ec,d,!0):this.ec.childNodes[this.eo-1])}}function k(a){return function(b,d){for(var e,k=d?b:b.parentNode;k;){e=k.nodeType;if(W(a,e))return k;k=k.parentNode}return null}}function z(a,b){if(ja(a,b))throw new H("INVALID_NODE_TYPE_ERR");}function m(a,b){if(!W(b,a.nodeType))throw new H("INVALID_NODE_TYPE_ERR");}function G(a,b){if(0>b||b>(u(a)?a.length:a.childNodes.length))throw new H("INDEX_SIZE_ERR");}function q(a,b){if(ca(a,!0)!==
ca(b,!0))throw new H("WRONG_DOCUMENT_ERR");}function p(a){if(ka(a,!0))throw new H("NO_MODIFICATION_ALLOWED_ERR");}function B(a,b){if(!a)throw new H(b);}function t(a){return ea&&x.isBrokenNode(a)||!W(fa,a.nodeType)&&!ca(a,!0)}function I(a,b){return b<=(u(a)?a.length:a.childNodes.length)}function M(a){return!!a.startContainer&&!!a.endContainer&&!t(a.startContainer)&&!t(a.endContainer)&&I(a.startContainer,a.startOffset)&&I(a.endContainer,a.endOffset)}function A(a){if(!M(a))throw Error("Range error: Range is no longer valid after DOM mutation ("+
a.inspect()+")");}function Q(a,b){A(a);var d=a.startContainer,e=a.startOffset,k=a.endContainer,c=a.endOffset,C=d===k;u(k)&&0<c&&c<k.length&&ba(k,c,b);u(d)&&0<e&&e<d.length&&(d=ba(d,e,b),C?(c-=e,k=d):k==d.parentNode&&c>=J(d)&&c++,e=0);a.setStartAndEnd(d,e,k,c)}function da(a){a.START_TO_START=0;a.START_TO_END=1;a.END_TO_END=2;a.END_TO_START=3;a.NODE_BEFORE=0;a.NODE_AFTER=1;a.NODE_BEFORE_AND_AFTER=2;a.NODE_INSIDE=3}function T(a){da(a);da(a.prototype)}function X(a,b){return function(){A(this);var d=this.startContainer,
k=this.startOffset,C=this.commonAncestorContainer,f=new e(this,!0);d!==C&&(d=V(d,C,!0),k=c(d),d=k.node,k=k.offset);D(f,p);f.reset();C=a(f);f.detach();b(this,d,k,d,k);return C}}function F(a,d){function k(a,b){return function(d){m(d,Z);m(N(d),fa);d=(a?l:c)(d);(b?C:g)(this,d.node,d.offset)}}function C(a,b,e){var k=a.endContainer,c=a.endOffset;if(b!==a.startContainer||e!==a.startOffset){if(N(b)!=N(k)||1==E(b,e,k,c))k=b,c=e;d(a,b,e,k,c)}}function g(a,b,e){var k=a.startContainer,c=a.startOffset;if(b!==
a.endContainer||e!==a.endOffset){if(N(b)!=N(k)||-1==E(b,e,k,c))k=b,c=e;d(a,k,c,b,e)}}var ca=function(){};ca.prototype=h.rangePrototype;a.prototype=new ca;S.extend(a.prototype,{setStart:function(a,b){z(a,!0);G(a,b);C(this,a,b)},setEnd:function(a,b){z(a,!0);G(a,b);g(this,a,b)},setStartAndEnd:function(){var a=arguments,b=a[0],e=a[1],k=b,c=e;switch(a.length){case 3:c=a[2];break;case 4:k=a[2],c=a[3]}d(this,b,e,k,c)},setBoundary:function(a,b,d){this["set"+(d?"Start":"End")](a,b)},setStartBefore:k(!0,!0),
setStartAfter:k(!1,!0),setEndBefore:k(!0,!1),setEndAfter:k(!1,!1),collapse:function(a){A(this);a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){z(a,!0);d(this,a,0,a,L(a))},selectNode:function(a){z(a,!1);m(a,Z);var b=l(a);a=c(a);d(this,b.node,b.offset,a.node,a.offset)},extractContents:X(f,d),deleteContents:X(b,d),canSurroundContents:function(){A(this);p(this.startContainer);
p(this.endContainer);var a=new e(this,!0),b=a._first&&r(a._first,this)||a._last&&r(a._last,this);a.detach();return!b},splitBoundaries:function(){Q(this)},splitBoundariesPreservingPositions:function(a){Q(this,a)},normalizeBoundaries:function(){A(this);var a=this.startContainer,b=this.startOffset,e=this.endContainer,k=this.endOffset,c=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(e=a,k=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},C=function(d){var c=d.previousSibling;if(c&&
c.nodeType==d.nodeType){a=d;var C=d.length;b=c.length;d.insertData(0,c.data);c.parentNode.removeChild(c);a==e?(k+=b,e=a):e==d.parentNode&&(c=J(d),k==c?(e=d,k=C):k>c&&k--)}},f=!0;u(e)?e.length==k&&c(e):(0<k&&(f=e.childNodes[k-1])&&u(f)&&c(f),f=!this.collapsed);f?u(a)?0==b&&C(a):b<a.childNodes.length&&(c=a.childNodes[b])&&u(c)&&C(c):(a=e,b=k);d(this,a,b,e,k)},collapseToPoint:function(a,b){z(a,!0);G(a,b);this.setStartAndEnd(a,b)}});T(a)}function K(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===
a.endOffset;a.commonAncestorContainer=a.collapsed?a.startContainer:x.getCommonAncestor(a.startContainer,a.endContainer)}function O(a,b,d,e,k){a.startContainer=b;a.startOffset=d;a.endContainer=e;a.endOffset=k;a.document=x.getDocument(b);K(a)}function P(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this.document=a;K(this)}var x=h.dom,S=h.util,U=x.DomPosition,H=h.DOMException,u=x.isCharacterDataNode,J=x.getNodeIndex,R=x.isOrIsAncestorOf,Y=x.getDocument,E=x.comparePoints,
ba=x.splitDataNode,V=x.getClosestAncestorIn,L=x.getNodeLength,W=x.arrayContains,N=x.getRootContainer,ea=h.features.crashyTextNodes;e.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;a&&(this._next=a!==this._last?a.nextSibling:null,u(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,
a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so)));return a},remove:function(){var a=this._current,b,d;!u(a)||a!==this.sc&&a!==this.ec?a.parentNode&&a.parentNode.removeChild(a):(b=a===this.sc?this.so:0,d=a===this.ec?this.eo:a.length,b!=d&&a.deleteData(b,d-b))},isPartiallySelectedSubtree:function(){return r(this._current,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse(!1);else{a=new P(g(this.range));
var b=this._current,d=b,k=0,c=b,C=L(b);R(b,this.sc)&&(d=this.sc,k=this.so);R(b,this.ec)&&(c=this.ec,C=this.eo);O(a,d,k,c,C)}return new e(a,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var Z=[1,3,4,5,7,8,10],fa=[2,9,11],aa=[1,3,4,5,7,8,10,11],C=[1,3,4,5,7,8],ca=k([9,11]),ka=k([5,6,10,12]),ja=k([6,10,12]),ia=document.createElement("style"),ga=!1;try{ia.innerHTML="\x3cb\x3ex\x3c/b\x3e",ga=3==
ia.firstChild.nodeType}catch(la){}h.features.htmlParsingConforms=ga;var ha="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" ");S.extend(h.rangePrototype,{compareBoundaryPoints:function(a,b){A(this);q(this.startContainer,b.startContainer);var d=3==a||0==a?"start":"end",e=1==a||0==a?"start":"end";return E(this[d+"Container"],this[d+"Offset"],b[e+"Container"],b[e+"Offset"])},insertNode:function(a){A(this);m(a,aa);p(this.startContainer);if(R(a,this.startContainer))throw new H("HIERARCHY_REQUEST_ERR");
a=v(a,this.startContainer,this.startOffset);this.setStartBefore(a)},cloneContents:function(){A(this);var a,b;if(this.collapsed)return g(this).createDocumentFragment();if(this.startContainer===this.endContainer&&u(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=g(this).createDocumentFragment(),b.appendChild(a),b;b=new e(this,!0);a=w(b);b.detach();return a},canSurroundContents:function(){A(this);p(this.startContainer);p(this.endContainer);
var a=new e(this,!0),b=a._first&&r(a._first,this)||a._last&&r(a._last,this);a.detach();return!b},surroundContents:function(a){m(a,C);if(!this.canSurroundContents())throw new H("INVALID_STATE_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);v(a,this.startContainer,this.startOffset);a.appendChild(b);this.selectNode(a)},cloneRange:function(){A(this);for(var a=new P(g(this)),b=ha.length,d;b--;)d=ha[b],a[d]=this[d];return a},toString:function(){A(this);
var a=this.startContainer;if(a===this.endContainer&&u(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],a=new e(this,!0);D(a,function(a){3!=a.nodeType&&4!=a.nodeType||b.push(a.data)});a.detach();return b.join("")},compareNode:function(a){A(this);var b=a.parentNode,d=J(a);if(!b)throw new H("NOT_FOUND_ERR");a=this.comparePoint(b,d);b=this.comparePoint(b,d+1);return 0>a?0<b?2:0:0<b?1:3},comparePoint:function(a,b){A(this);B(a,"HIERARCHY_REQUEST_ERR");q(a,
this.startContainer);return 0>E(a,b,this.startContainer,this.startOffset)?-1:0<E(a,b,this.endContainer,this.endOffset)?1:0},createContextualFragment:ga?function(a){var b=this.startContainer,d=Y(b);if(!b)throw new H("INVALID_STATE_ERR");var e=null;1==b.nodeType?e=b:u(b)&&(e=x.parentElement(b));e=null===e||"HTML"==e.nodeName&&x.isHtmlNamespace(Y(e).documentElement)&&x.isHtmlNamespace(e)?d.createElement("body"):e.cloneNode(!1);e.innerHTML=a;return x.fragmentFromNodeChildren(e)}:function(a){var b=g(this).createElement("body");
b.innerHTML=a;return x.fragmentFromNodeChildren(b)},toHtml:function(){A(this);var a=this.commonAncestorContainer.parentNode.cloneNode(!1);a.appendChild(this.cloneContents());return a.innerHTML},intersectsNode:function(a,b){A(this);B(a,"NOT_FOUND_ERR");if(Y(a)!==g(this))return!1;var d=a.parentNode,e=J(a);B(d,"NOT_FOUND_ERR");var k=E(d,e,this.endContainer,this.endOffset),d=E(d,e+1,this.startContainer,this.startOffset);return b?0>=k&&0<=d:0>k&&0<d},isPointInRange:function(a,b){A(this);B(a,"HIERARCHY_REQUEST_ERR");
q(a,this.startContainer);return 0<=E(a,b,this.startContainer,this.startOffset)&&0>=E(a,b,this.endContainer,this.endOffset)},intersectsRange:function(a){return y(this,a,!1)},intersectsOrTouchesRange:function(a){return y(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=E(this.startContainer,this.startOffset,a.startContainer,a.startOffset),d=E(this.endContainer,this.endOffset,a.endContainer,a.endOffset),e=this.cloneRange();-1==b&&e.setStart(a.startContainer,a.startOffset);1==d&&
e.setEnd(a.endContainer,a.endOffset);return e}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();-1==E(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset);1==E(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset);return b}throw new H("Ranges do not intersect");},containsNode:function(a,b){return b?this.intersectsNode(a,!1):3==this.compareNode(a)},containsNodeContents:function(a){return 0<=
this.comparePoint(a,0)&&0>=this.comparePoint(a,L(a))},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var d=b.getNodes([3]);return 0<d.length?(b.setStart(d[0],0),a=d.pop(),b.setEnd(a,a.length),this.containsRange(b)):this.containsNodeContents(a)},getNodes:function(b,d){A(this);return a(this,b,d)},getDocument:function(){return g(this)},collapseBefore:function(a){this.setEndBefore(a);this.collapse(!1)},
collapseAfter:function(a){this.setStartAfter(a);this.collapse(!0)},getBookmark:function(a){var b=g(this),d=h.createRange(b);a=a||x.getBody(b);d.selectNodeContents(a);var b=this.intersection(d),e=0,k=0;b&&(d.setEnd(b.startContainer,b.startOffset),e=d.toString().length,k=e+b.toString().length);return{start:e,end:k,containerNode:a}},moveToBookmark:function(a){var b=a.containerNode,d=0;this.setStart(b,0);this.collapse(!0);for(var b=[b],e,k=!1,c=!1,C,f;!c&&(e=b.pop());)if(3==e.nodeType)C=d+e.length,!k&&
a.start>=d&&a.start<=C&&(this.setStart(e,a.start-d),k=!0),k&&a.end>=d&&a.end<=C&&(this.setEnd(e,a.end-d),c=!0),d=C;else for(f=e.childNodes,C=f.length;C--;)b.push(f[C])},getName:function(){return"DomRange"},equals:function(a){return P.rangesEqual(this,a)},isValid:function(){return M(this)},inspect:function(){return d(this)},detach:function(){}});F(P,O);S.extend(P,{rangeProperties:ha,RangeIterator:e,copyComparisonConstants:T,createPrototypeRange:F,inspect:d,getRangeDocument:g,rangesEqual:function(a,
b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}});h.DomRange=P});
rangy.createCoreModule("WrappedRange",["DomRange"],function(h,n){var r,g,l=h.dom,c=h.util,v=l.DomPosition,y=h.DomRange,w=l.getBody,D=l.getContentDocument,b=l.isCharacterDataNode;h.features.implementsDomRange&&function(){function a(b){for(var e=d.length,k;e--;)k=d[e],b[k]=b.nativeRange[k];b.collapsed=b.startContainer===b.endContainer&&b.startOffset===b.endOffset}var b,d=y.rangeProperties,f;r=function(b){if(!b)throw n.createError("WrappedRange: Range must be specified");this.nativeRange=b;a(this)};
y.createPrototypeRange(r,function(a,b,d,e,k){var c=a.startContainer!==b||a.startOffset!=d,f=a.endContainer!==e||a.endOffset!=k,z=!a.equals(a.nativeRange);if(c||f||z)a.setEnd(e,k),a.setStart(b,d)});b=r.prototype;b.selectNode=function(b){this.nativeRange.selectNode(b);a(this)};b.cloneContents=function(){return this.nativeRange.cloneContents()};b.surroundContents=function(b){this.nativeRange.surroundContents(b);a(this)};b.collapse=function(b){this.nativeRange.collapse(b);a(this)};b.cloneRange=function(){return new r(this.nativeRange.cloneRange())};
b.refresh=function(){a(this)};b.toString=function(){return this.nativeRange.toString()};var g=document.createTextNode("test");w(document).appendChild(g);var q=document.createRange();q.setStart(g,0);q.setEnd(g,0);try{q.setStart(g,1),b.setStart=function(b,d){this.nativeRange.setStart(b,d);a(this)},b.setEnd=function(b,d){this.nativeRange.setEnd(b,d);a(this)},f=function(b){return function(d){this.nativeRange[b](d);a(this)}}}catch(p){b.setStart=function(b,d){try{this.nativeRange.setStart(b,d)}catch(k){this.nativeRange.setEnd(b,
d),this.nativeRange.setStart(b,d)}a(this)},b.setEnd=function(b,d){try{this.nativeRange.setEnd(b,d)}catch(k){this.nativeRange.setStart(b,d),this.nativeRange.setEnd(b,d)}a(this)},f=function(b,d){return function(k){try{this.nativeRange[b](k)}catch(c){this.nativeRange[d](k),this.nativeRange[b](k)}a(this)}}}b.setStartBefore=f("setStartBefore","setEndBefore");b.setStartAfter=f("setStartAfter","setEndAfter");b.setEndBefore=f("setEndBefore","setStartBefore");b.setEndAfter=f("setEndAfter","setStartAfter");
b.selectNodeContents=function(a){this.setStartAndEnd(a,0,l.getNodeLength(a))};q.selectNodeContents(g);q.setEnd(g,3);f=document.createRange();f.selectNodeContents(g);f.setEnd(g,4);f.setStart(g,2);-1==q.compareBoundaryPoints(q.START_TO_END,f)&&1==q.compareBoundaryPoints(q.END_TO_START,f)?b.compareBoundaryPoints=function(a,b){b=b.nativeRange||b;a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END);return this.nativeRange.compareBoundaryPoints(a,b)}:b.compareBoundaryPoints=function(a,
b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};f=document.createElement("div");f.innerHTML="123";var B=f.firstChild,t=w(document);t.appendChild(f);q.setStart(B,1);q.setEnd(B,2);q.deleteContents();"13"==B.data&&(b.deleteContents=function(){this.nativeRange.deleteContents();a(this)},b.extractContents=function(){var b=this.nativeRange.extractContents();a(this);return b});t.removeChild(f);t=null;c.isHostMethod(q,"createContextualFragment")&&(b.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)});
w(document).removeChild(g);b.getName=function(){return"WrappedRange"};h.WrappedRange=r;h.createNativeRange=function(a){a=D(a,n,"createNativeRange");return a.createRange()}}();if(h.features.implementsTextRange){var f=function(a,d,c,f,g){var h=a.duplicate();h.collapse(c);var p=h.parentElement();l.isOrIsAncestorOf(d,p)||(p=d);if(!p.canHaveHTML)return p=new v(p.parentNode,l.getNodeIndex(p)),{boundaryPosition:p,nodeInfo:{nodeIndex:p.offset,containerElement:p.node}};d=l.getDocument(p).createElement("span");
d.parentNode&&d.parentNode.removeChild(d);var B,t=c?"StartToStart":"StartToEnd",n=g&&g.containerElement==p?g.nodeIndex:0,r=p.childNodes.length,A=r;for(g=A;;){g==r?p.appendChild(d):p.insertBefore(d,p.childNodes[g]);h.moveToElementText(d);B=h.compareEndPoints(t,a);if(0==B||n==A)break;else if(-1==B)if(A==n+1)break;else n=g;else A=A==n+1?n:g;g=Math.floor((n+A)/2);p.removeChild(d)}t=d.nextSibling;if(-1==B&&t&&b(t)){h.setEndPoint(c?"EndToStart":"EndToEnd",a);if(/[\r\n]/.test(t.data))for(c=h.duplicate(),
f=c.text.replace(/\r\n/g,"\r").length,f=c.moveStart("character",f);-1==c.compareEndPoints("StartToEnd",c);)f++,c.moveStart("character",1);else f=h.text.length;c=new v(t,f)}else a=(f||!c)&&d.previousSibling,c=(c=(f||c)&&d.nextSibling)&&b(c)?new v(c,0):a&&b(a)?new v(a,a.data.length):new v(p,l.getNodeIndex(d));d.parentNode.removeChild(d);return{boundaryPosition:c,nodeInfo:{nodeIndex:g,containerElement:p}}},a=function(a,d){var c,f,g=a.offset,h=l.getDocument(a.node),p=w(h).createTextRange(),B=b(a.node);
B?(c=a.node,f=c.parentNode):(c=a.node.childNodes,c=g<c.length?c[g]:null,f=a.node);h=h.createElement("span");h.innerHTML="\x26#feff;";c?f.insertBefore(h,c):f.appendChild(h);p.moveToElementText(h);p.collapse(!d);f.removeChild(h);if(B)p[d?"moveStart":"moveEnd"]("character",g);return p};g=function(a){this.textRange=a;this.refresh()};g.prototype=new y(document);g.prototype.refresh=function(){var a,b,d;d=this.textRange;a=d.parentElement();var c=d.duplicate();c.collapse(!0);b=c.parentElement();c=d.duplicate();
c.collapse(!1);d=c.parentElement();b=b==d?b:l.getCommonAncestor(b,d);b=b==a?b:l.getCommonAncestor(a,b);a=this.textRange;0==a.compareEndPoints("StartToEnd",a)?b=a=f(this.textRange,b,!0,!0).boundaryPosition:(d=f(this.textRange,b,!0,!1),a=d.boundaryPosition,b=f(this.textRange,b,!1,!1,d.nodeInfo).boundaryPosition);this.setStart(a.node,a.offset);this.setEnd(b.node,b.offset)};g.prototype.getName=function(){return"WrappedTextRange"};y.copyComparisonConstants(g);g.rangeToTextRange=function(b){if(b.collapsed)return a(new v(b.startContainer,
b.startOffset),!0);var d=a(new v(b.startContainer,b.startOffset),!0),c=a(new v(b.endContainer,b.endOffset),!1);b=w(y.getRangeDocument(b)).createTextRange();b.setEndPoint("StartToStart",d);b.setEndPoint("EndToEnd",c);return b};h.WrappedTextRange=g;if(!h.features.implementsDomRange||h.config.preferTextRange){var d=function(){return this}();"undefined"==typeof d.Range&&(d.Range=g);h.createNativeRange=function(a){a=D(a,n,"createNativeRange");return w(a).createTextRange()};h.WrappedRange=g}}h.createRange=
function(a){a=D(a,n,"createRange");return new h.WrappedRange(h.createNativeRange(a))};h.createRangyRange=function(a){a=D(a,n,"createRangyRange");return new y(a)};h.createIframeRange=function(a){n.deprecationNotice("createIframeRange()","createRange(iframeEl)");return h.createRange(a)};h.createIframeRangyRange=function(a){n.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)");return h.createRangyRange(a)};h.addCreateMissingNativeApiListener(function(a){var b=a.document;"undefined"==
typeof b.createRange&&(b.createRange=function(){return h.createRange(b)});b=a=null})});
rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(h,n){function r(a){return"string"==typeof a?/^backward(s)?$/i.test(a):!!a}function g(a,b){if(a){if(B.isWindow(a))return a;if(a instanceof e)return a.win;var d=B.getContentDocument(a,n,b);return B.getWindow(d)}return window}function l(a){return g(a,"getWinSelection").getSelection()}function c(a){return g(a,"getDocSelection").document.selection}function v(a){var b=!1;a.anchorNode&&(b=1==B.comparePoints(a.anchorNode,a.anchorOffset,
a.focusNode,a.focusOffset));return b}function y(a,b,d){var e=d?"end":"start";d=d?"start":"end";a.anchorNode=b[e+"Container"];a.anchorOffset=b[e+"Offset"];a.focusNode=b[d+"Container"];a.focusOffset=b[d+"Offset"]}function w(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function D(a){var b;a instanceof M?(b=h.createNativeRange(a.getDocument()),b.setEnd(a.endContainer,a.endOffset),b.setStart(a.startContainer,a.startOffset)):a instanceof
A?b=a.nativeRange:F.implementsDomRange&&a instanceof B.getWindow(a.startContainer).Range&&(b=a);return b}function b(a){var b=a.getNodes(),d;a:if(b.length&&1==b[0].nodeType){d=1;for(var e=b.length;d<e;++d)if(!B.isAncestorOf(b[0],b[d])){d=!1;break a}d=!0}else d=!1;if(!d)throw n.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return b[0]}function f(a,b){var d=new A(b);a._ranges=[d];y(a,d,!1);a.rangeCount=1;a.isCollapsed=d.collapsed}function a(a){a._ranges.length=
0;if("None"==a.docSelection.type)w(a);else{var b=a.docSelection.createRange();if(b&&"undefined"!=typeof b.text)f(a,b);else{a.rangeCount=b.length;for(var d,e=K(b.item(0)),k=0;k<a.rangeCount;++k)d=h.createRange(e),d.selectNode(b.item(k)),a._ranges.push(d);a.isCollapsed=1==a.rangeCount&&a._ranges[0].collapsed;y(a,a._ranges[a.rangeCount-1],!1)}}}function d(d,e){for(var k=d.docSelection.createRange(),c=b(e),f=K(k.item(0)),f=O(f).createControlRange(),m=0,z=k.length;m<z;++m)f.add(k.item(m));try{f.add(c)}catch(g){throw n.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");
}f.select();a(d)}function e(a,b,d){this.nativeSelection=a;this.docSelection=b;this._ranges=[];this.win=d;this.refresh()}function k(a){a.win=a.anchorNode=a.focusNode=a._ranges=null;a.rangeCount=a.anchorOffset=a.focusOffset=0;a.detached=!0}function z(a,b){for(var d=N.length,e,c;d--;)if(e=N[d],c=e.selection,"deleteAll"==b)k(c);else if(e.win==a)return"delete"==b?(N.splice(d,1),!0):c;"deleteAll"==b&&(N.length=0);return null}function m(d,e){for(var k=K(e[0].startContainer),k=O(k).createControlRange(),c=
0,f,m=e.length;c<m;++c){f=b(e[c]);try{k.add(f)}catch(z){throw n.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)");}}k.select();a(d)}function G(a,b){if(a.win.document!=K(b))throw new Q("WRONG_DOCUMENT_ERR");}function q(a){return function(b,d){var e;this.rangeCount?(e=this.getRangeAt(0),e["set"+(a?"Start":"End")](b,d)):(e=h.createRange(this.win.document),e.setStartAndEnd(b,d));this.setSingleRange(e,this.isBackward())}}
function p(a){var b=[],d=new da(a.anchorNode,a.anchorOffset),e=new da(a.focusNode,a.focusOffset),k="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var c=0,f=a.rangeCount;c<f;++c)b[c]=M.inspect(a.getRangeAt(c));return"["+k+"(Ranges: "+b.join(", ")+")(anchor: "+d.inspect()+", focus: "+e.inspect()+"]"}h.config.checkSelectionRanges=!0;var B=h.dom,t=h.util,I=t.isHostMethod,M=h.DomRange,A=h.WrappedRange,Q=h.DOMException,da=B.DomPosition,T,X,F=h.features,K=B.getDocument,
O=B.getBody,P=M.rangesEqual,x=I(window,"getSelection"),S=t.isHostObject(document,"selection");F.implementsWinGetSelection=x;var U=(F.implementsDocSelection=S)&&(!x||h.config.preferTextRange);U?(T=c,h.isSelectionValid=function(a){a=g(a,"isSelectionValid").document;var b=a.selection;return"None"!=b.type||K(b.createRange().parentElement())==a}):x?(T=l,h.isSelectionValid=function(){return!0}):n.fail("Neither document.selection or window.getSelection() detected.");h.getNativeSelection=T;var x=T(),H=h.createNativeRange(document),
u=O(document),J=t.areHostProperties(x,["anchorNode","focusNode","anchorOffset","focusOffset"]);F.selectionHasAnchorAndFocus=J;var R=I(x,"extend");F.selectionHasExtend=R;var Y="number"==typeof x.rangeCount;F.selectionHasRangeCount=Y;var E=!1,ba=!0,V=R?function(a,b){var d=M.getRangeDocument(b),d=h.createRange(d);d.collapseToPoint(b.endContainer,b.endOffset);a.addRange(D(d));a.extend(b.startContainer,b.startOffset)}:null;t.areHostMethods(x,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof x.rangeCount&&
F.implementsDomRange&&function(){var a=window.getSelection();if(a){for(var b=a.rangeCount,d=1<b,e=[],k=v(a),c=0;c<b;++c)e[c]=a.getRangeAt(c);var c=O(document),f=c.appendChild(document.createElement("div"));f.contentEditable="false";var m=f.appendChild(document.createTextNode("   ")),z=document.createRange();z.setStart(m,1);z.collapse(!0);a.addRange(z);ba=1==a.rangeCount;a.removeAllRanges();d||(d=z.cloneRange(),z.setStart(m,0),d.setEnd(m,3),d.setStart(m,2),a.addRange(z),a.addRange(d),E=2==a.rangeCount,
d.detach());c.removeChild(f);a.removeAllRanges();for(c=0;c<b;++c)0==c&&k?V?V(a,e[c]):(h.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),a.addRange(e[c])):a.addRange(e[c])}}();F.selectionSupportsMultipleRanges=E;F.collapsedNonEditableSelectionsSupported=ba;var L=!1;u&&I(u,"createControlRange")&&(u=u.createControlRange(),t.areHostProperties(u,["item","add"])&&(L=!0));F.implementsControlRange=
L;X=J?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var W;I(x,"getRangeAt")?W=function(a,b){try{return a.getRangeAt(b)}catch(d){return null}}:J&&(W=function(a){var b=K(a.anchorNode),b=h.createRange(b);b.setStartAndEnd(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset);b.collapsed!==this.isCollapsed&&b.setStartAndEnd(a.focusNode,a.focusOffset,a.anchorNode,a.anchorOffset);return b});e.prototype=
h.selectionPrototype;var N=[],ea=function(a){if(a&&a instanceof e)return a.refresh(),a;a=g(a,"getNativeSelection");var b=z(a),d=T(a),k=S?c(a):null;b?(b.nativeSelection=d,b.docSelection=k,b.refresh()):(b=new e(d,k,a),N.push({win:a,selection:b}));return b};h.getSelection=ea;h.getIframeSelection=function(a){n.deprecationNotice("getIframeSelection()","getSelection(iframeEl)");return h.getSelection(B.getIframeWindow(a))};u=e.prototype;if(!U&&J&&t.areHostMethods(x,["removeAllRanges","addRange"]))u.removeAllRanges=
function(){this.nativeSelection.removeAllRanges();w(this)},u.addRange=Y?function(a,b){if(L&&S&&"Control"==this.docSelection.type)d(this,a);else if(r(b)&&R)V(this.nativeSelection,a),this.refresh();else{var e;E?e=this.rangeCount:(this.removeAllRanges(),e=0);this.nativeSelection.addRange(D(a).cloneRange());this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==e+1?(h.config.checkSelectionRanges&&(e=W(this.nativeSelection,this.rangeCount-1))&&!P(e,a)&&(a=new A(e)),this._ranges[this.rangeCount-
1]=a,y(this,a,aa(this.nativeSelection)),this.isCollapsed=X(this)):this.refresh()}}:function(a,b){r(b)&&R?V(this.nativeSelection,a):this.nativeSelection.addRange(D(a));this.refresh()},u.setRanges=function(a){if(L&&1<a.length)m(this,a);else{this.removeAllRanges();for(var b=0,d=a.length;b<d;++b)this.addRange(a[b])}};else if(I(x,"empty")&&I(H,"select")&&L&&U)u.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=K(this.anchorNode);else if("Control"==
this.docSelection.type){var b=this.docSelection.createRange();b.length&&(a=K(b.item(0)))}a&&(O(a).createTextRange().select(),this.docSelection.empty())}}catch(d){}w(this)},u.addRange=function(a){"Control"==this.docSelection.type?d(this,a):(h.WrappedTextRange.rangeToTextRange(a).select(),this._ranges[0]=a,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,y(this,a,!1))},u.setRanges=function(a){this.removeAllRanges();var b=a.length;1<b?m(this,a):b&&this.addRange(a[0])};else return n.fail("No means of selecting a Range or TextRange was found"),
!1;u.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new Q("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var Z;if(U)Z=function(b){var d;h.isSelectionValid(b.win)?d=b.docSelection.createRange():(d=O(b.win.document).createTextRange(),d.collapse(!0));"Control"==b.docSelection.type?a(b):d&&"undefined"!=typeof d.text?f(b,d):w(b)};else if(I(x,"getRangeAt")&&"number"==typeof x.rangeCount)Z=function(b){if(L&&S&&"Control"==b.docSelection.type)a(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,
b.rangeCount){for(var d=0,e=b.rangeCount;d<e;++d)b._ranges[d]=new h.WrappedRange(b.nativeSelection.getRangeAt(d));y(b,b._ranges[b.rangeCount-1],aa(b.nativeSelection));b.isCollapsed=X(b)}else w(b)};else if(J&&"boolean"==typeof x.isCollapsed&&"boolean"==typeof H.collapsed&&F.implementsDomRange)Z=function(a){var b;b=a.nativeSelection;b.anchorNode?(b=W(b,0),a._ranges=[b],a.rangeCount=1,b=a.nativeSelection,a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset,
a.isCollapsed=X(a)):w(a)};else return n.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;u.refresh=function(a){var b=a?this._ranges.slice(0):null,d=this.anchorNode,e=this.anchorOffset;Z(this);if(a){a=b.length;if(a!=this._ranges.length||this.anchorNode!=d||this.anchorOffset!=e)return!0;for(;a--;)if(!P(b[a],this._ranges[a]))return!0;return!1}};var fa=function(a,b){var d=a.getAllRanges();a.removeAllRanges();for(var e=0,k=d.length;e<k;++e)P(b,d[e])||a.addRange(d[e]);
a.rangeCount||w(a)};u.removeRange=L?function(d){if("Control"==this.docSelection.type){var e=this.docSelection.createRange();d=b(d);for(var k=K(e.item(0)),k=O(k).createControlRange(),c,f=!1,m=0,z=e.length;m<z;++m)c=e.item(m),c!==d||f?k.add(e.item(m)):f=!0;k.select();a(this)}else fa(this,d)}:function(a){fa(this,a)};var aa;!U&&J&&F.implementsDomRange?(aa=v,u.isBackward=function(){return aa(this)}):aa=u.isBackward=function(){return!1};u.isBackwards=u.isBackward;u.toString=function(){for(var a=[],b=0,
d=this.rangeCount;b<d;++b)a[b]=""+this._ranges[b];return a.join("")};u.collapse=function(a,b){G(this,a);var d=h.createRange(a);d.collapseToPoint(a,b);this.setSingleRange(d);this.isCollapsed=!0};u.collapseToStart=function(){if(this.rangeCount){var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new Q("INVALID_STATE_ERR");};u.collapseToEnd=function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)}else throw new Q("INVALID_STATE_ERR");
};u.selectAllChildren=function(a){G(this,a);var b=h.createRange(a);b.selectNodeContents(a);this.setSingleRange(b)};u.deleteFromDocument=function(){if(L&&S&&"Control"==this.docSelection.type){for(var a=this.docSelection.createRange(),b;a.length;)b=a.item(0),a.remove(b),b.parentNode.removeChild(b);this.refresh()}else if(this.rangeCount&&(a=this.getAllRanges(),a.length)){this.removeAllRanges();b=0;for(var d=a.length;b<d;++b)a[b].deleteContents();this.addRange(a[d-1])}};u.eachRange=function(a,b){for(var d=
0,e=this._ranges.length;d<e;++d)if(a(this.getRangeAt(d)))return b};u.getAllRanges=function(){var a=[];this.eachRange(function(b){a.push(b)});return a};u.setSingleRange=function(a,b){this.removeAllRanges();this.addRange(a,b)};u.callMethodOnEachRange=function(a,b){var d=[];this.eachRange(function(e){d.push(e[a].apply(e,b))});return d};u.setStart=q(!0);u.setEnd=q(!1);h.rangePrototype.select=function(a){ea(this.getDocument()).setSingleRange(this,a)};u.changeEachRange=function(a){var b=[],d=this.isBackward();
this.eachRange(function(d){a(d);b.push(d)});this.removeAllRanges();d&&1==b.length?this.addRange(b[0],"backward"):this.setRanges(b)};u.containsNode=function(a,b){return this.eachRange(function(d){return d.containsNode(a,b)},!0)};u.getBookmark=function(a){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[a])}};u.moveToBookmark=function(a){for(var b=[],d=0,e,k;e=a.rangeBookmarks[d++];)k=h.createRange(this.win),k.moveToBookmark(e),b.push(k);a.backward?this.setSingleRange(b[0],
"backward"):this.setRanges(b)};u.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")};u.getName=function(){return"WrappedSelection"};u.inspect=function(){return p(this)};u.detach=function(){z(this.win,"delete");k(this)};e.detachAll=function(){z(null,"deleteAll")};e.inspect=p;e.isDirectionBackward=r;h.Selection=e;h.selectionPrototype=u;h.addCreateMissingNativeApiListener(function(a){"undefined"==typeof a.getSelection&&(a.getSelection=function(){return ea(a)});a=null})});
(function(h){function n(a){return a}function r(a){var b=h.map(a.attributes,function(a){return a.name});h(a).removeClass();h.each(b,function(b,d){a.removeAttribute(d)})}function g(a){return"br"==ice.dom.getTagName(a)}function l(a){a=ice.dom.getTagName(a);return"br"===a||"p"===a}function c(a,b,e){var k=a.length;if(0>b||b>=k)return a;b+e>=k&&(e=k-b);if(e===k)return a;a=0<b?a.splitText(b):a;a.length>e&&a.splitText(e);return a}function v(a,b,e,k){k?b.collapsed&&b.startContainer&&b.startContainer.nodeType===
ice.dom.TEXT_NODE&&b.startContainer.length||(e=e.createTextNode("﻿"),a?a.appendChild(e):b.insertNode(e),b.selectNode(e)):a&&b.selectNodeContents(a)}var y,w,D=[{start:0,end:31},{start:33,end:40},{start:45,end:45},{start:91,end:93},{start:112,end:123},{start:144,end:145}];y={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",sessionId:"data-session-id",time:"data-time",lastTime:"data-last-change-time",changeData:"data-changedata"},attrValuePrefix:"",blockEl:"p",blockEls:"div p ol ul li h1 h2 h3 h4 h5 h6 blockquote".split(" "),
stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"ins",alias:"ins",action:"Inserted"},deleteType:{tag:"del",alias:"del",action:"Deleted"}},contentEditable:void 0,_isTracking:!0,tooltips:!1,tooltipsDelay:1,_isVisible:!0,_changeData:null,_handleSelectAll:!1,_sessionId:null};w=function(a){a||(a={});if(!a.element)throw Error("options.element must be defined for ice construction.");this._changes={};this._userStyles={};this.currentUser={name:"",id:""};this._styles={};this._savedNodesMap=
{};this.$this=h(this);this._browser=ice.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);ice.dom.extend(!0,this,y,a);if(a.tooltips&&(!h.isFunction(a.hostMethods.showTooltip)||!h.isFunction(a.hostMethods.hideTooltip)))throw Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true");var b=a.userStyles||{},e;for(e in b)if(b.hasOwnProperty(e)){var k=b[e];isNaN(k)||(this._userStyles[e]=this.stylePrefix+
"-"+k,this._uniqueStyleIndex=Math.max(k,this._uniqueStyleIndex),this._styles[k]=!0)}f=a.hostMethods.logError||function(){};this._insertSelector="."+this._getIceNodeClass("insertType");this._deleteSelector="."+this._getIceNodeClass("deleteType");this._iceSelector=this._insertSelector+","+this._deleteSelector};w.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeId:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(a){"boolean"==typeof this.contentEditable&&
this.element.setAttribute("contentEditable",this.contentEditable);this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(a){this._isTracking=!1;try{this.element&&this.unlistenToEvents(),a||"undefined"===typeof this.contentEditable||this.element.setAttribute("contentEditable",!this.contentEditable)}catch(b){f(b,"While trying to stop tracking")}this._updateTooltipsState();return this},listenToEvents:function(){this.element&&
!this._boundEventHandler&&(this.unlistenToEvents(),this._boundEventHandler=this.handleEvent.bind(this),this.element.addEventListener("keydown",this._boundEventHandler,!0))},unlistenToEvents:function(){this.element&&this._boundEventHandler&&this.element.removeEventListener("keydown",this._boundEventHandler,!0);this._boundEventHandler=null},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||
this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=!0},disableChangeTracking:function(){this._isTracking=!1},toggleChangeTracking:function(a){this._isTracking=a=void 0===a?!this._isTracking:Boolean(a)},getCurrentUser:function(){var a=
this.currentUser||{};return{name:a.name||"",id:null===a.id||void 0===a.id?"":String(a.id)}},setCurrentUser:function(a){var b={};a=a||{};b.name=a.name?String(a.name):"";b.id=void 0!==a.id&&null!==a.id?String(a.id):"";this.currentUser=b;for(var e in this._changes)a=this._changes[e],a.userid==b.id&&(a.username=b.name);e=this.getIceNodes();var k,c=this.attributes.userId;e.each(function(a,e){k=e.getAttribute(c);null!==k&&k!==b.id||e.setAttribute(this.attributes.userName,b.name)}.bind(this))},setSessionId:function(a){this._sessionId=
a},toggleTooltips:function(a){this.tooltips=a=void 0===a?!this.tooltips:Boolean(a);this._updateTooltipsState()},visible:function(a){a.nodeType===ice.dom.TEXT_NODE&&(a=a.parentNode);a=a.getBoundingClientRect();return 0<a.top&&0<a.left},_createIceNode:function(a,b,e){var k=this.env.document.createElement(this.changeTypes[a].tag);k.setAttribute("class",this._getIceNodeClass(a));b&&k.appendChild(b);this._addChange(a,[k],e);return k},insert:function(a){this.hostMethods.beforeInsert&&this.hostMethods.beforeInsert();
var b=this.getCurrentRange(),e=(b=this._isRangeInElement(b,this.element))?null:this.hostMethods.getHostRange(),k=this._startBatchChange(),c=!(!b||b.collapsed),m=!1;a=a||{};try{if(c&&(this._deleteContents(!1,b),b=this.getCurrentRange()),b||e){var g=a.nodes;g&&!h.isArray(g)&&(g=[g]);this._moveRangeToValidTrackingPos(b,e);m=this._insertNodes(b,e,{nodes:g,text:a.text,insertStubText:!1!==a.insertStubText})}}catch(q){f(q,"while trying to insert nodes")}finally{this._endBatchChange(k)}return m},_deleteContents:function(a,
b){var e=!0,k=this._browser;this.hostMethods.beforeDelete&&this.hostMethods.beforeDelete();b?this.selection.addRange(b):b=this.getCurrentRange();var c=this._startBatchChange();try{if(!1===b.collapsed)(b=this._deleteSelection(b))&&!this.visible(b.endContainer)&&(b.setEnd(b.endContainer,Math.max(0,b.endOffset-1)),b.collapse(!1));else{this._cleanupSelection(b,!1,!0);if(this._isCurrentUserIceNode(this._getIceNode(b.startContainer,"insertType")))return!1;if(a)if("mozilla"===k.type)e=this._deleteRight(b),
this.visible(b.endContainer)||(b.endContainer.parentNode.nextSibling?b.setEndBefore(b.endContainer.parentNode.nextSibling):b.setEndAfter(b.endContainer),b.collapse(!1));else{if(b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var f=b.startContainer.nextSibling;if(ice.dom.is(f,this._deleteSelector))for(;f;)if(ice.dom.is(f,this._deleteSelector))f=f.nextSibling;else{b.setStart(f,0);b.collapse(!0);break}}e=this._deleteRight(b);!this.visible(b.endContainer)&&ice.dom.is(b.endContainer.parentNode,
this._iceSelector)&&(b.setStartAfter(b.endContainer.parentNode),b.collapse(!0))}else if(k.mozilla)e=this._deleteLeft(b),this.visible(b.startContainer)||(b.startContainer.parentNode.previousSibling?b.setEnd(b.startContainer.parentNode.previousSibling,0):b.setEnd(b.startContainer.parentNode,0),b.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(b.endContainer)),b.collapse(!1));else{if(!this.visible(b.startContainer)&&b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var g=b.startContainer.previousSibling;
if(ice.dom.is(g,this._deleteSelector))for(;g;)if(ice.dom.is(g,this._deleteSelector))g=g.prevSibling;else{b.setEndBefore(g.nextSibling,0);b.collapse(!1);break}}e=this._deleteLeft(b)}}b&&this.selection.addRange(b)}finally{this._endBatchChange(c)}return e},getChanges:function(a){a=a?this._filterChanges(a):this._changes;return h.extend({},a)},getChangeUserids:function(){var a=this,b=Object.keys(this._changes);return b.map(function(e){return a._changes[b[e]].userid}).sort().filter(function(a,b,d){return b===
d.indexOf(a)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b,e){return(a=this.getCleanDOM(a,{callback:b,prepare:e,clone:!0}))&&a.innerHTML||""},getCleanDOM:function(a,b){var e="",k=this;b=b||{};ice.dom.each(this.changeTypes,function(a,b){"deleteType"!==a&&(0<b&&(e+=","),e+="."+k._getIceNodeClass(a))});a?"string"===typeof a?a=ice.dom.create("\x3cdiv\x3e"+a+"\x3c/div\x3e"):b.clone&&(a=ice.dom.cloneNode(a,!1)[0]):a=b.clone?ice.dom.cloneNode(this.element,
!1)[0]:this.element;return this._cleanBody(a,e,b)},_cleanBody:function(a,b,e){a=e.prepare?e.prepare.call(this,a):a;b=ice.dom.find(a,b);ice.dom.each(b,function(a,b){for(;b.firstChild;)b.parentNode.insertBefore(b.firstChild,b);b.parentNode.removeChild(b)});b=ice.dom.find(a,this._deleteSelector);ice.dom.remove(b);return a=e.callback?e.callback.call(this,a):a},acceptAll:function(a){if(a)return this._acceptRejectSome(a,!0);this.getCleanDOM(this.element,{clone:!1});this._changes={};this._triggerChange()},
rejectAll:function(a){if(a)return this._acceptRejectSome(a,!1);a=this._deleteSelector;var b,e=this;ice.dom.find(this.element,this._insertSelector).each(function(a,b){e._removeNode(b)});ice.dom.each(ice.dom.find(this.element,a),function(a,c){b=ice.dom.contents(c);ice.dom.replaceWith(c,b);h.each(b,function(a,b){e._normalizeNode(b&&b.parentNode)})});this._changes={};this._triggerChange()},acceptChange:function(a){this.acceptRejectChange(a,!0)},rejectChange:function(a){this.acceptRejectChange(a,!1)},
acceptRejectChange:function(a,b){var e,c,f,m,g=ice.dom,q=this,p,B,t=this._userStyles,n,v=this.attributes.userId,A=this._getIceNodeClass("deleteType"),y=this._getIceNodeClass("insertType");if(!a){m=this.getCurrentRange();if(!m||!m.collapsed)return;a=m.startContainer}e=f="."+A;c=m="."+y;b||(f=c,m=e);e=g.getNode(a,e+","+c);e=g.attr(e,this.attributes.changeId);f=g.find(this.element,f+"["+this.attributes.changeId+"\x3d"+e+"]");c=f.length;f.each(function(a,b){q._removeNode(b)});f=g.find(this.element,m+
"["+this.attributes.changeId+"\x3d"+e+"]");c+=f.length;g.each(f,function(a,b){if(l(b))return r(b);n=b.getAttribute(v);B=null!==n?t[n]||"":"";p=ice.dom.contents(b);h(b).removeClass(y+" "+A+" "+B);g.replaceWith(b,p);h.each(p,function(a,b){var d=ice.dom.TEXT_NODE==b.nodeType&&b.nodeValue;if(d){for(var e=!1;0<=d.indexOf("  ");)e=!0,d=d.replace("  ","  ");e&&(b.nodeValue=d)}q._normalizeNode(b&&b.parentNode)})});delete this._changes[e];0<c&&this._triggerChange()},isInsideChange:function(a,b,e){try{return Boolean(this.currentChangeNode(a,
b,e))}catch(c){return f(c,"While testing if isInsideChange"),!1}},getIceNodes:function(){var a=[],b=this;ice.dom.each(this.changeTypes,function(e){a.push("."+b._getIceNodeClass(e))});a=a.join(",");return h(this.element).find(a)},_getIceNode:function(a,b){var e=this.changeTypes[b].tag+"."+this._getIceNodeClass(b);return ice.dom.getNode(a&&a.$||a,e)},_isNodeOfChangeType:function(a,b){if(!a)return!1;var e="."+this._getIceNodeClass(b);return ice.dom.is(a.$||a,e)},_isInsertNode:function(a){return this._isNodeOfChangeType(a,
"insertType")},_isDeleteNode:function(a){return this._isNodeOfChangeType(a,"deleteType")},_normalizeNode:function(a){return ice.dom.normalizeNode(a,this._browser.msie)},_moveRangeToValidTrackingPos:function(a,b){if(a=b||a)for(var e,c,g=-1,m,h=[],q=b?this.hostMethods.getHostNode:n,p=!1;!p;){c=a.startContainer;if(!c||0<=h.indexOf(c))break;m=q(c);h.push(c);if(e=this._getVoidElement(m)){if(e!==c&&0<=h.indexOf(e))break;h.push(e)}else p=ice.dom.isTextContainer(m);if(!p){if(-1==g){g=q(a.startContainer);
c=a.startOffset;if(g)var l=g.nodeType,g=ice.dom.TEXT_NODE==l?c&&g.nodeValue&&c>=g.nodeValue.length-1:ice.dom.ELEMENT_NODE==l?g.childNodes&&g.childNodes.length&&c>=g.childNodes.length:!1;else g=!1;g=!g}e=g?ice.dom.findPrevTextContainer(e||m,this.element):ice.dom.findNextTextContainer(e||m,this.element);m=e.node;b&&(m=this.hostMethods.makeHostElement(m));try{g?a.setStart(m,e.offset):a.setEnd(m,e.offset),a.collapse(g)}catch(t){f(t,"While trying to move range to valid tracking position");break}}}},_isRangeInElement:function(a,
b){for(var e=a&&a.startContainer;e;){if(e==b)return a;e=e.parentNode}return null},_getVoidElement:function(a){try{var b=this._getIceNode(a,"deleteType");return b||3!=a.nodeType||"​"!=a.nodeValue?b:a}catch(e){return f(e,"While trying to get void element of",a),null}},_cleanupSelection:function(a,b,e){var c;if(a&&a.collapsed&&(c=a.startContainer))return b&&(c=this.hostMethods.getHostNode(c)),ice.dom.TEXT_NODE==c.nodeType?this._cleanupTextSelection(a,c,b,e):this._cleanupElementSelection(a,b)},_cleanupTextSelection:function(a,
b,e,c){this._cleanupAroundNode(b);if(c&&ice.dom.isEmptyTextNode(b)){c=b.parentNode;var f=ice.dom.getNodeIndex(b);e=e?this.hostMethods.makeHostElement:n;c.removeChild(b);f=Math.max(0,f);a.setStart(e(c),f);a.setEnd(e(c),f)}},_cleanupElementSelection:function(a,b){var e,c=!1,f=b?this.hostMethods.getHostNode(a.startContainer):a.startContainer,g=f.childNodes.length;if(!(1>g)){try{if(0<a.startOffset?e=f.childNodes[a.startOffset-1]:(e=f.firstChild,c=!0),!e)return}catch(h){return}this._cleanupAroundNode(e,
c);0!==a.startOffset&&(c=ice.dom.getNodeIndex(e)+1,ice.dom.isEmptyTextNode(e)&&(c=Math.max(0,c-1),f.removeChild(e)),f.childNodes.length!==g&&(e=b?this.hostMethods.makeHostElement:n,a.setStart(e(f),c),a.setEnd(e(f),c)))}},_cleanupAroundNode:function(a,b){for(var e=a.parentNode,c=a.nextSibling,f;c;)ice.dom.isEmptyTextNode(c)?(f=c,c=c.nextSibling,e.removeChild(f)):c=c.nextSibling;for(c=a.previousSibling;c;)ice.dom.isEmptyTextNode(c)?(f=c,c=c.previousSibling,e.removeChild(f)):c=c.previousSibling;b&&ice.dom.isEmptyTextNode(a)&&
e.removeChild(a)},_isCurrentUserIceNode:function(a){var b=Boolean(a&&ice.dom.attr(a,this.attributes.userId)===this.currentUser.id);b&&this._sessionId&&(b=ice.dom.attr(a,this.attributes.sessionId)===this._sessionId);return b},_getChangeTypeFromAlias:function(a){var b,e=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&this.changeTypes[b].alias==a&&(e=b);return e},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},_getUserStyle:function(a){if(null===
a||""===a||"undefined"==typeof a)return this.stylePrefix;var b=null;return b=this._userStyles[a]?this._userStyles[a]:this._setUserStyle(a,this._getNewStyleId())},_setUserStyle:function(a,b){var e=this.stylePrefix+"-"+b;this._styles[b]||(this._styles[b]=!0);return this._userStyles[a]=e},_getNewStyleId:function(){var a=++this._uniqueStyleIndex;if(this._styles[a])return this._getNewStyleId();this._styles[a]=!0;return a},_addChange:function(a,b,e){var c=e||this._batchChangeId||this.getNewChangeId(),f=
this;this._changes[c]||(e=(new Date).getTime(),this._changes[c]={type:a,time:e,lastTime:e,sessionId:this._sessionId,userid:String(this.currentUser.id),username:this.currentUser.name,data:this._changeData||""},this._triggerChange());ice.dom.foreach(b,function(a){f._addNodeToChange(c,b[a])});return c},_addNodeToChange:function(a,b){var e=this.getChange(a),c={};b.getAttribute(this.attributes.changeId)||(c[this.attributes.changeId]=a);var f=b.getAttribute(this.attributes.userId);f||(f=e.userid,c[this.attributes.userId]=
f);f==e.userid&&(c[this.attributes.userName]=e.username);null===b.getAttribute(this.attributes.changeData)&&(c[this.attributes.changeData]=this._changeData||"");b.getAttribute(this.attributes.time)||(c[this.attributes.time]=e.time);b.getAttribute(this.attributes.lastTime)||(c[this.attributes.lastTime]=e.lastTime);e.sessionId&&!b.getAttribute(this.attributes.sessionId)&&(c[this.attributes.sessionId]=e.sessionId);e.style||(e.style=this._getUserStyle(e.userid));h(b).attr(c).addClass(e.style);this._updateNodeTooltip(b)},
getChange:function(a){return this._changes[a]||null},getNewChangeId:function(){var a=++this._uniqueIDIndex;this._changes[a]&&(a=this.getNewChangeId());return a},_startBatchChange:function(){return this._batchChangeId?null:this._batchChangeId=this.getNewChangeId()},getContentElement:function(){return this.element},_endBatchChange:function(a){a&&a===this._batchChangeId&&(this._batchChangeId=null,this._triggerChangeText())},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(a){return f(a,
"While trying to get current range"),null}},_insertNodes:function(a,b,e){a=b||a;e=e||{};var c=a.startContainer,f=b?this.hostMethods.makeHostElement:n,g=e.nodes,h=!1!==e.insertStubText,q=e.text,p,l=this.env.document;e=!1;p=this._getIceNode(c&&c.$||c,"insertType");c=this._isCurrentUserIceNode(p);this._cleanupSelection(a,Boolean(b),!0);if(c){c=g&&g[0];q=p.getAttribute(this.attributes.changeId);if(c){e=!0;a.insertNode(f(c));f=c.parentNode;l=c.nextSibling;p=g.length;for(h=1;h<p;++h)l?f.insertBefore(g[h],
l):f.appendChild(g[h]);g=g[p-1];ice.dom.TEXT_NODE==g.nodeType?a.setEnd(g,g.nodeValue&&g.nodeValue.length||0):a.setEndAfter(g);a.collapse();b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}else v(null,a,l,h);this._updateChangeTime(q)}else{c=this._createIceNode("insertType");if(p){var t=p.childNodes.length;this._normalizeNode(p);t!==p.childNodes.length&&(b?b=a=this.hostMethods.getHostRange():a.refresh());p&&(t=b&&this.hostMethods.getHostNode(b.endContainer)||a.endContainer,3==t.nodeType&&
a.endOffset<a.endContainer.length||t!==p.lastChild)&&(p=this._splitNode(p,a.endContainer,a.endOffset))}p&&(a.setStartAfter(f(p)),a.collapse(!0));a.insertNode(f(c));if(p=g&&g.length||0){e=!0;for(h=0;h<p;++h)c.appendChild(g[h]);a.setEndAfter(f(c.lastChild));a.collapse()}else q?(e=!0,g=l.createTextNode(q),c.appendChild(g),a.setEnd(g,1),a.collapse()):v(c,a,l,h);b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}return e},_updateChangeTime:function(a){var b=this._changes[a];if(b){var c=(new Date).getTime();
a=ice.dom.find(this.element,"["+this.attributes.changeId+"\x3d"+a+"]");var f=this.attributes.lastTime;b.lastTime=c;a.each(function(a,b){b.setAttribute(f,c)})}},_handleVoidEl:function(a,b){var c=a&&this._getVoidElement(a);return c&&!this._getIceNode(c,"deleteType")?(b.collapse(!0),!0):!1},_deleteSelection:function(a){for(var b=new ice.Bookmark(this.env,a),c=ice.dom.getElementsBetween(b.start,b.end),f=[],h=0;h<c.length;h++){var m=c[h];if(m&&m.parentNode){if(ice.dom.isBlockElement(m)&&(f.push(m),!ice.dom.canContainTextElement(m))){for(var l=
0;l<m.childNodes.length;l++)c.push(m.childNodes[l]);continue}if(ice.dom.isEmptyTextNode(m))this._removeNode(m);else if(!this._getVoidElement(m))if(m.nodeType!==ice.dom.TEXT_NODE)if(g(m))this._addDeleteTrackingToBreak(m);else if(ice.dom.isStubElement(m))this._addDeleteTracking(m,{range:null,moveLeft:!0});else if(ice.dom.hasNoTextOrStubContent(m))this._removeNode(m);else for(l=0;l<m.childNodes.length;l++)c.push(m.childNodes[l]);else l=ice.dom.getBlockParent(m),this._addDeleteTracking(m,{range:null,
moveLeft:!0}),ice.dom.hasNoTextOrStubContent(l)&&ice.dom.remove(l)}}b.selectBookmark();(a=this.getCurrentRange())&&a.collapse(!0);return a},_deleteRight:function(a){var b=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||ice.dom.getBlockParent(a.startContainer,this.element)||null,e=b?ice.dom.hasNoTextOrStubContent(b):!1,f=b&&ice.dom.getNextContentNode(b,this.element),h=f?ice.dom.hasNoTextOrStubContent(f):!1,m=a.endContainer,l=a.endOffset,q=a.commonAncestorContainer,p,n=!1;if(e)return!1;
if(g(q))return this._addDeleteTrackingToBreak(q,{range:a}),!0;if(q.nodeType!==ice.dom.TEXT_NODE){if(0===l&&ice.dom.isBlockElement(q)&&!ice.dom.canContainTextElement(q)&&(b=q.firstElementChild))return a.setStart(b,0),a.collapse(),this._deleteRight(a);if(q.childNodes.length>l){b=q.childNodes[l];if(g(b))return this._addDeleteTrackingToBreak(b,{range:a}),!0;a.setStart(q.childNodes[l],0);a.collapse(!0);n=this._deleteRight(a);a.refresh();return n}if(p=ice.dom.getNextContentNode(q,this.element)){if(g(p))return this._addDeleteTrackingToBreak(p,
{range:a}),!0;a.setEnd(p,0)}a.collapse();return this._deleteRight(a)}try{a.moveEnd(ice.dom.CHARACTER_UNIT,1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(t){}if(l===m.data.length&&!ice.dom.hasNoTextOrStubContent(m)){p=ice.dom.getNextNode(m,this.element);if(!p)return a.selectNodeContents(m),a.collapse(),!1;if(g(p))return this._addDeleteTrackingToBreak(p,{range:a}),!0;p.nodeType===ice.dom.TEXT_NODE&&(p=p.parentNode);if(!p.isContentEditable)return n=this._addDeleteTracking(p,{range:null,moveLeft:!1,merge:!0}),
b=this.env.document.createTextNode(""),p.parentNode.insertBefore(b,p.nextSibling),a.selectNode(b),a.collapse(!0),n;if(this._handleVoidEl(p,a))return!0;if(ice.dom.isChildOf(p,b)&&ice.dom.isStubElement(p))return this._addDeleteTracking(p,{range:a,moveLeft:!1,merge:!0})}if(this._handleVoidEl(p,a))return!0;if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(p,this.element),this.blockEl)){f!==ice.dom.getBlockParent(a.endContainer,
this.element)&&a.setEnd(f,0);q=ice.dom.getElementsBetween(a.startContainer,a.endContainer);for(l=0;l<q.length;l++)ice.dom.remove(q[l]);return ice.dom.mergeBlockWithSibling(a,ice.dom.getBlockParent(a.endContainer,this.element)||b)}if(h)return ice.dom.remove(f),a.collapse(!0),!0;a.setStart(f,0);a.collapse(!0);return!0}b=c(a.endContainer,a.endOffset,1);return this._addDeleteTracking(b,{range:a,moveLeft:!1,merge:!0})},_deleteLeft:function(a){var b=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||
ice.dom.getBlockParent(a.startContainer,this.element)||null,e=b?ice.dom.hasNoTextOrStubContent(b):!1,f=b&&ice.dom.getPrevContentNode(b,this.element),h=f?ice.dom.hasNoTextOrStubContent(f):!1,m=a.startContainer,l=a.startOffset,q=a.commonAncestorContainer;if(e)return!1;if(g(q))return this._addDeleteTrackingToBreak(q,{range:a,moveLeft:!0}),!0;if(0===l||q.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(q)&&!ice.dom.canContainTextElement(q))if(0===l){if(e=q.firstElementChild)return a.setStart(e,
0),a.collapse(),this._deleteLeft(a)}else if(e=q.lastElementChild)if(e=a.getLastSelectableChild(e))return a.setStart(e,e.data.length),a.collapse(),this._deleteLeft(a);m=0===l?ice.dom.getPrevContentNode(m,this.element):q.childNodes[l-1];if(!m)return!1;ice.dom.is(m,this._iceSelector)&&0<m.childNodes.length&&m.lastChild&&(m=m.lastChild);if(g(m))return this._addDeleteTrackingToBreak(m,{range:a,moveLeft:!0}),!0;m.nodeType===ice.dom.TEXT_NODE&&(m=m.parentNode);if(!m.isContentEditable)return b=this._addDeleteTracking(m,
{range:null,moveLeft:!0,merge:!0}),f=document.createTextNode(""),m.parentNode.insertBefore(f,m),a.selectNode(f),a.collapse(!0),b;if(this._handleVoidEl(m,a))return!0;if(ice.dom.isStubElement(m)&&ice.dom.isChildOf(m,b)||!m.isContentEditable)return this._addDeleteTracking(m,{range:a,moveLeft:!0,merge:!0}),!0;if(ice.dom.isStubElement(m))return ice.dom.remove(m),a.collapse(!0),!1;if(m!==b&&!ice.dom.isChildOf(m,b)){ice.dom.canContainTextElement(m)||(m=m.lastElementChild);if(m.lastChild&&m.lastChild.nodeType!==
ice.dom.TEXT_NODE&&ice.dom.isStubElement(m.lastChild)&&"BR"!==m.lastChild.tagName)return a.setStartAfter(m.lastChild),a.collapse(!0),!0;if((e=a.getLastSelectableChild(m))&&!ice.dom.isOnBlockBoundary(a.startContainer,e,this.element))return a.selectNodeContents(e),a.collapse(),!0}}if(1===l&&!ice.dom.isBlockElement(q)&&1<a.startContainer.childNodes.length&&a.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===a.startContainer.childNodes[0].data.length)return a.setStart(a.startContainer,0),
this._deleteLeft(a);try{a.moveStart(ice.dom.CHARACTER_UNIT,-1),a.moveStart(ice.dom.CHARACTER_UNIT,1)}catch(p){}if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(h)return ice.dom.remove(f),a.collapse(),!0;if(f&&f.lastChild&&ice.dom.isStubElement(f.lastChild))return a.setStartAfter(f.lastChild),a.collapse(!0),!0;(e=a.getLastSelectableChild(f))?(a.setStart(e,e.data.length),a.collapse(!0)):f&&(a.setStart(f,f.childNodes.length),a.collapse(!0));return!0}return(b=a.startContainer)&&
b.nodeType===ice.dom.TEXT_NODE?(b=c(b,a.startOffset-1,1),this._addDeleteTracking(b,{range:a,moveLeft:!0,merge:!0}),!0):!1},_removeNode:function(a){var b=a&&a.parentNode;b&&(b.removeChild(a),b!==this.element&&ice.dom.hasNoTextOrStubContent(b)&&this._removeNode(b))},_addDeleteTracking:function(a,b){var c=b&&b.moveLeft,f=this._getIceNode(a,"insertType"),g;if(f)return this._addDeletionInInsertNode(a,f,b);if((f=b&&b.range)&&this._getIceNode(a,"deleteType"))return this._deleteInDeleted(a,b);a.previousSibling&&
ice.dom.isEmptyTextNode(a.previousSibling)&&a.parentNode.removeChild(a.previousSibling);a.nextSibling&&ice.dom.isEmptyTextNode(a.nextSibling)&&a.parentNode.removeChild(a.nextSibling);g=this._getIceNode(a.previousSibling,"deleteType");var h=this._getIceNode(a.nextSibling,"deleteType");if(g&&this._isCurrentUserIceNode(g)){if(g.appendChild(a),h&&this._isCurrentUserIceNode(h)){var l=ice.dom.extractContent(h);ice.dom.append(g,l);h.parentNode.removeChild(h)}}else h&&this._isCurrentUserIceNode(h)?(g=h,g.insertBefore(a,
g.firstChild)):(h=this.getAdjacentChangeId(a,c),g=this._createIceNode("deleteType",null,h),a.parentNode.insertBefore(g,a),g.appendChild(a));f&&(ice.dom.isStubElement(a)?f.selectNode(a):f.selectNodeContents(a),c?f.collapse(!0):f.collapse());g&&(this._normalizeNode(g),f&&f.refresh());return!0},_addDeleteTrackingToBreak:function(a,b){function c(){var e=b&&b.range;e&&(g(a)||ice.dom.hasNoTextOrStubContent(a)||k?k?(e.setStartBefore(a),e.setEndBefore(a)):(e.setStartAfter(a),e.setEndAfter(a)):a.firstChild&&
(e.setStartBefore(a.firstChild),e.setEndBefore(a.firstChild)),e.collapse())}var k=Boolean(b&&b.moveLeft);if(g(a)){if(this._isDeleteNode(a))return c();r(a);ice.dom.addClass(a,this._getIceNodeClass("deleteType"));var h=this.getAdjacentChangeId(a,k);this._addChange("deleteType",[a],h);c()}else f("addDeleteTracking to BR: not a break element")},_deleteInDeleted:function(a,b){var c=b.range,f=b.moveLeft;this._normalizeNode(a);var g=!1;if(f){for(var h=ice.dom.getPrevContentNode(a,this.element);!g;)(f=this._getIceNode(h,
"deleteType"))?h=ice.dom.getPrevContentNode(h,this.element):g=!0;h&&((g=c.getLastSelectableChild(h))&&(h=g),c.setStart(h,ice.dom.getNodeCharacterLength(h)),c.collapse(!0))}else{for(h=ice.dom.getNextContentNode(a,this.element);!g;)(f=this._getIceNode(h,"deleteType"))?h=ice.dom.getNextContentNode(h,this.element):g=!0;h&&(c.selectNodeContents(h),c.collapse(!0))}return!0},_addDeletionInInsertNode:function(a,b,c){var f=c&&c.range,g=c&&c.moveLeft;if(this._isCurrentUserIceNode(b))f&&(g?f.setStartBefore(a):
f.setStartAfter(a),f.collapse(g)),a.parentNode.removeChild(a),this._browser.msie||this._normalizeNode(b),0<ice.dom.find(b,".iceBookmark").length?(a=ice.dom.cloneNode(b),ice.dom.remove(ice.dom.find(a,".iceBookmark")),a=a[0]):a=b,ice.dom.hasNoTextOrStubContent(a)&&(f&&(f.setStartBefore(b),f.collapse(!0)),ice.dom.replaceWith(b,ice.dom.contents(b)));else{var h=rangy.dom.getNodeIndex(a),l=a.parentNode,q=l.childNodes.length,p;l.removeChild(a);p=this._createIceNode("deleteType");p.appendChild(a);0<h&&h>=
q-1?ice.dom.insertAfter(b,p):(0<h&&this._splitNode(b,l,h),b.parentNode.insertBefore(p,b));this._deleteEmptyNode(b);f&&g&&(f.setStartBefore(p),f.collapse(!0),this.selection.addRange(f));c&&c.merge&&this._mergeDeleteNode(p);f&&f.refresh()}return!0},_deleteEmptyNode:function(a){var b=a&&a.parentNode;b&&ice.dom.hasNoTextOrStubContent(a)&&b.removeChild(a)},_mergeDeleteNode:function(a){var b,c;this._isCurrentUserIceNode(b=this._getIceNode(a.previousSibling,"deleteType"))?(c=ice.dom.extractContent(a),a.parentNode.removeChild(a),
ice.dom.append(b,c),this._mergeDeleteNode(b)):this._isCurrentUserIceNode(b=this._getIceNode(a.nextSibling,"deleteType"))&&(c=ice.dom.extractContent(b),a.parentNode.removeChild(b),ice.dom.append(a,c),this._mergeDeleteNode(a))},handleEvent:function(a){if(!this._isTracking)return!0;var b=!1;"keypress"==a.type?b=this.keyPress(a):"keydown"==a.type&&(b=!this.handleKeyDown(a));b&&(a.stopImmediatePropagation(),a.preventDefault(),this.hostMethods.notifyChange());return!b},_handleAncillaryKey:function(a){var b=
this._browser,c=!1,f=this.getCurrentRange();switch(a){case ice.dom.DOM_VK_DELETE:c=this._deleteContents();break;case 46:c=this._deleteContents(!0);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:"mozilla"!==b.type||this.visible(f.startContainer)||(f.startContainer.parentNode.previousSibling?(f.setEnd(f.startContainer.parentNode.previousSibling,0),f.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(f.endContainer))):f.setEnd(f.startContainer.parentNode.nextSibling,
0),f.collapse(!1));c=!1;break;case ice.dom.DOM_VK_RIGHT:"mozilla"===b.type&&!this.visible(f.startContainer)&&f.startContainer.parentNode.nextSibling&&(f.setStart(f.startContainer.parentNode.nextSibling,0),f.collapse(!0))}return c},handleKeyDown:function(a){return this._handleSpecialKey(a)?!0:!this.keyPress(a)},onKeyDown:function(a){return this._handleSpecialKey(a)?!1:this._handleAncillaryKey(a)},keyPress:function(a){var b=null;if(a.ctrlKey||a.metaKey)return!1;var c=(b=this.getCurrentRange())&&ice.dom.parents(b.startContainer,
"br")[0]||null;c&&b.moveToNextEl(c);a=a.keyCode?a.keyCode:a.which;switch(a){case 32:return this.insert({text:" "});case ice.dom.DOM_VK_DELETE:case 46:case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:case ice.dom.DOM_VK_RIGHT:return this._handleAncillaryKey(a);case ice.dom.DOM_VK_ENTER:return this._handleEnter(),!1;default:a:if(a){for(var c=D.length,f,b=0;b<c;++b)if(f=D[b],a>=f.start&&a<=f.end){b=!0;break a}b=!1}else b=!0;return b?!1:(b=String.fromCharCode(a))?(a=this._browser.msie?
{text:b}:null,this.insert(a)):!1}},_handleEnter:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._deleteContents()},_handleSpecialKey:function(a){var b=a.which;null===b&&(b=a.keyCode);switch(b){case 120:case 88:if(!0===a.ctrlKey||!0===a.metaKey)return this.prepareToCut(),!0;break;case 67:case 99:if(!0===a.ctrlKey||!0===a.metaKey)return this.prepareToCopy(),!0}return!1},currentChangeNode:function(a,b,c){var f=this._iceSelector,g=null;if(!a){g=this.getCurrentRange();if(!g)return!1;!1!==
c&&g.collapsed?(this._cleanupSelection(g,!1,!1),a=g.startContainer):a=g.commonAncestorContainer}a=b?ice.dom.is(a,f)&&a:ice.dom.getNode(a,f);if(!a&&g&&g.collapsed){b=g.endContainer;g=g.endOffset;c=null;if(b.nodeType===ice.dom.TEXT_NODE)g===b.length?c=ice.dom.getNextNode(b):0===g&&(c=ice.dom.getPrevNode(b,this.element));else if(b.nodeType===ice.dom.ELEMENT_NODE)if(0===g)c=ice.dom.getPrevNode(b,this.element);else if(b.childNodes.length>g){b=b.childNodes[g-1];if(ice.dom.is(b,f))return b;c=ice.dom.getNextNode(b)}c&&
(a=ice.dom.is(c,f))}return a},setShowChanges:function(a){this._isVisible=a=!!a;h(this.element).toggleClass("ICE-Tracking",a);this._showTitles(a);this._updateTooltipsState()},reload:function(){this._loadFromDom()},hasChanges:function(){for(var a in this._changes){var b=this._changes[a];if(b&&b.type)return!0}return!1},countChanges:function(a){return this._filterChanges(a).count},setChangeData:function(a){if(null==a||"undefined"==typeof a)a="";this._changeData=String(a)},getDeleteClass:function(){return this._getIceNodeClass("deleteType")},
prepareToCopy:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._removeTrackingInRange(a)},prepareToCut:function(){var a=this.getCurrentRange(),b=this.hostMethods.getHostRange();if(a&&b&&a.collapsed&&!b.collapsed)try{var c=this.hostMethods.getHostRangeData(b);a.setStart(c.startContainer,c.startOffset);a.setEnd(c.endContainer,c.endOffset)}catch(g){return}if(!a||a.collapsed)return!1;b=this.element;if(a&&b&&!a.collapsed){var h;try{for(;(h=a.endContainer)&&h!==b&&0==a.endOffset&&!a.collapsed&&
(h.previousSibling?a.setEndBefore(h):h.parentNode&&h.parentNode!==b&&a.setEndBefore(h.parentNode),a.endContainer!=h););}catch(m){f(m,"fixSelection, while trying to set end")}try{for(;(h=a.startContainer)&&h!==b&&!a.collapsed&&(h=a.startContainer,h.nodeType==ice.dom.TEXT_NODE?a.startOffset>=h.nodeValue.length&&a.setStartAfter(h):a.startOffset>=h.childNodes.length&&a.setStartAfter(h),a.startContainer!=h););}catch(l){f(l,"fixSelection, while trying to set start")}}b=a.cloneContents();h=a.cloneRange();
var c=b.firstChild,q=b.lastChild;this.hostMethods.beforeEdit();a.collapse(!1);a.insertNode(b);a.setStartBefore(c);a.setEndAfter(q);b=this._startBatchChange();try{this._deleteSelection(a)}catch(p){f(p,"While trying to delete selection")}finally{this._endBatchChange(b),this.selection.addRange(h),this._removeTrackingInRange(h,!1)}return!0},toString:function(){return"ICE "+(this.element&&this.element.id||"(no element id)")},_splitNode:function(a,b,c){var f=a.parentNode,g=rangy.dom.getNodeIndex(a),h=b.ownerDocument.createRange();
h.setStart(f,g);h.setEnd(b,c);b=h.extractContents();f.insertBefore(b,a);this.isInsideChange(a,!0)&&this._updateNodeTooltip(a.previousSibling);return a.previousSibling},_triggerChange:function(){this._isTracking&&this.$this.trigger("change")},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(a){this.tooltips&&this._isVisible&&this._addTooltip(a)},_acceptRejectSome:function(a,b){var c=function(a,c){this.acceptRejectChange(c,b)}.bind(this),f=this._filterChanges(a),
g;for(g in f.changes)ice.dom.find(this.element,"["+this.attributes.changeId+"\x3d"+g+"]").each(c);f.count&&this._triggerChange()},_filterChanges:function(a){var b=0,c={},f;f=a||{};a=f.filter;var g=f.exclude?h.map(f.exclude,function(a){return String(a)}):null,m=f.include?h.map(f.include,function(a){return String(a)}):null,l=f.verify,q=null,p;for(p in this._changes)(f=this._changes[p])&&f.type&&(q=a&&!a({userid:f.userid,time:f.time,data:f.data})||g&&0<=g.indexOf(f.userid)||m&&0>m.indexOf(f.userid),
q||(l&&(q=ice.dom.find(this.element,"["+this.attributes.changeId+"]"),q=!q.length),q||(++b,c[p]=f)));return{count:b,changes:c}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var a=this.currentUser&&this.currentUser.id,b=this.currentUser&&this.currentUser.name||"",c=(new Date).getTime(),f,g=new RegExp(this.stylePrefix+"-(\\d+)"),h=[],l;for(l in this.changeTypes)h.push(this._getIceNodeClass(l));l=this.getIceNodes();var q=function(l,q){var t=0,n,v="",r=q.className.split(" ");for(l=
0;l<r.length;l++){if(f=g.exec(r[l]))n=f[0],t=f[1];var y=(new RegExp("("+h.join("|")+")")).exec(r[l]);y&&(v=this._getChangeTypeFromAlias(y[1]))}r=ice.dom.attr(q,this.attributes.userId);a&&r==a?(y=b,q.setAttribute(this.attributes.userName,b)):y=q.getAttribute(this.attributes.userName);this._setUserStyle(r,Number(t));t=parseInt(ice.dom.attr(q,this.attributes.changeId)||"");isNaN(t)&&(t=this.getNewChangeId(),q.setAttribute(this.attributes.changeId,t));var w=parseInt(q.getAttribute(this.attributes.time)||
"");isNaN(w)&&(w=c);var G=parseInt(q.getAttribute(this.attributes.lastTime)||"");isNaN(G)&&(G=w);var D=q.getAttribute(this.attributes.sessionId),F=ice.dom.attr(q,this.attributes.changeData)||"";this._changes[t]={type:v,style:n,userid:String(r),username:y,time:w,lastTime:G,sessionId:D,data:F};this._updateNodeTooltip(q)}.bind(this);l.each(q);this._triggerChange()},_showTitles:function(a){var b=this.getIceNodes();a?h(b).each(function(a,b){this._updateNodeTooltip(b)}.bind(this)):h(b).removeAttr("title")},
_updateTooltipsState:function(){var a,b=this;this.tooltips&&this._isVisible?this._showingTips||(this._showingTips=!0,a=this.getIceNodes(),a.each(function(a,c){b._addTooltip(c)})):this._showingTips&&(this._showingTips=!1,a=this.getIceNodes(),a.each(function(a,b){h(b).unbind("mouseover").unbind("mouseout")}))},_addTooltip:function(a){h(a).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(a){var b=a.currentTarget,c=h(b),
f=this;a.buttons||c.data("_tooltip_t")||(a=setTimeout(function(){var a=f.currentChangeNode(b),g=a&&a.getAttribute(f.attributes.changeId),h=g&&f.getChange(g);h&&(a=ice.dom.hasClass(a,f._getIceNodeClass("insertType"))?"insert":"delete",c.removeData("_tooltip_t"),f.hostMethods.showTooltip(b,{userName:h.username,changeId:g,userId:h.userid,time:h.time,lastTime:h.lastTime,type:a}))},this.tooltipsDelay),c.data("_tooltip_t",a))},_tooltipMouseOut:function(a){a=a.currentTarget;var b=h(a),c=b.data("_tooltip_t");
b.removeData("_tooltip_t");c?clearTimeout(c):this.hostMethods.hideTooltip(a)},_removeTrackingInRangeOld:function(a){var b=this._getIceNodeClass("insertType"),c=this._getIceNodeClass("deleteType"),f="."+b+",."+c;a.getNodes(null,function(a){var b=null;a.nodeType==ice.dom.TEXT_NODE?b=h(a).parents(f):(a=h(a),b=a.is(f)?a:a.parents(f));return(a=b&&b[0])?(a.setAttribute("data-ice-class",a.className),a.setAttribute("class","ice-no-decoration"),!0):!1});var g=this.element;setTimeout(function(){h(g).find("[data-ice-class]").each(function(a,
b){var c=b.getAttribute("data-ice-class");c&&(b.setAttribute("class",c),b.removeAttribute("data-ice-class"))})},10)},_removeTrackingInRange:function(a){var b=this._getIceNodeClass("insertType"),c=this._getIceNodeClass("deleteType"),g="."+b+",."+c,l=this._savedNodesMap,m=Date.now()%1E6;a.getNodes(null,function(a){var b=null;a.nodeType==ice.dom.TEXT_NODE?b=h(a).parents(g):(a=h(a),b=a.is(g)?a:a.parents(g));if(a=b&&b[0]){for(var c=a.attributes,f,d=c&&c.length,b={},e=0;e<d;++e)f=c[e],b[f.name]=f.value;
f=a.className;c=String(m++);l[c]={attributes:b,className:f};a:{var b=null,n;try{for(;0<a.attributes.length;){n=a.attributes[0];if(n===b)break a;b=n;a.removeAttribute(n.name)}}catch(v){}}a.setAttribute("data-ice-class",c);a.setAttribute("class","ice-no-decoration");return!0}return!1});var n=this.element;setTimeout(function(){h(n).find("[data-ice-class]").each(function(a,b){var c=b.getAttribute("data-ice-class"),d=l[c];c?(delete l[c],Object.keys(d.attributes).forEach(function(a){b.setAttribute(a,d.attributes[a])}),
b.setAttribute("class",d.className),b.removeAttribute("data-ice-class")):f("missing save data for node")})},10)},_onDomMutation:function(a){var c,f=a.length,g,h,l;for(c=0;c<f;++c)switch(g=a[c],g.type){case "childList":for(h=g.addedNodes,g=h.length-1;0<=g;--g)l=h[g],b.log("mutation: added node",l.tagName)}},_setDomObserverTimeout:function(){var a=this;this._domObserverTimeout&&window.clearTimeout(this._domObserverTimeout);this._domObserverTimeout=window.setTimeout(function(){a._domObserverTimeout=
null;a._domObserver.disconnect()},1)},getAdjacentChangeId:function(a,b){var c=b?ice.dom.getNextNode(a):ice.dom.getPrevNode(a),f,g=null;(f=this._getIceNode(c,"insertType")||this._getIceNode(c,"deleteType"))||!this._isInsertNode(c)&&!this._isDeleteNode(c)||(f=c);f&&this._isCurrentUserIceNode(f)&&(g=ice.dom.attr(f,this.attributes.changeId));return g}};var b=window&&window.console||{log:function(){},error:function(){},info:function(){},assert:function(){},count:function(){}},f=null;this.ice=this.ice||
{};this.ice.printRange=function(a,c){function f(a){if(!a)return"";a=a.replace("/\n/g","\\n").replace("/\r/g","").replace("​","{filler}").replace("﻿","{filler}");return 15>=a.length?a:a.substring(0,5)+"..."+a.substring(a.length-5)}function g(a){if(3===a.nodeType)a="Text:"+f(a.nodeValue);else{var b=a.innerText;a=a.nodeName+(b?"("+f(b)+")":"")}l.push("\x3c"+a+" /\x3e")}function h(a,b,c){"number"!==typeof c&&(c=-1);if(3==a.nodeType)a=a.nodeValue,l.push(f(a.substring(0,b))),l.push("|"),c>b?(l.push(f(a.substring(b,
c))),l.push("|"),l.push(f(a.substring(c)))):l.push(f(a.substring(b)));else if(1==a.nodeType){var d=0,n=a.childNodes;g(a);for(d=0;d<b;++d)g(n[d]);l.push("|");if(c>b){for(d=b;d<c;++d)g(n[d]);l.push("|")}if(0<c&&c<n.length)for(b=n[c];b;)g(b),b=b.nextSibling}}if(a&&a.startContainer&&a.endContainer){var l=[];a.startContainer===a.endContainer?h(a.startContainer,a.startOffset,a.endOffset):(h(a.startContainer,a.startOffset),h(a.endContainer,a.endOffset));var n=l.join(" ");c&&b.log(c+":"+n);return n}};this.ice.InlineChangeEditor=
w}).call(this,window.jQuery);
(function(h){function n(b){if(!b)return!0;for(var c=b.length-1,a;0<=c;)if(a=b[c--],"​"!==a&&"﻿"!==a)return!1;return!0}function r(b,f){for(;b;){if(c.TEXT_NODE==b.nodeType)return b;for(var a=b.firstChild;a;a=a.nextSibling){var d=r(a,f);if(d)return d}if(c.isTextContainer(b))return b;b=b.nextSibling}return null}function g(b,f){for(;b;){if(c.TEXT_NODE==b.nodeType)return b;for(var a=b.lastChild;a;a=a.previousSibling){var d=g(a,f);if(d)return d}if(c.isTextContainer(b))return b;b=b.previousSibling}return null}
function l(b){if(b)for(var c=b.firstChild;c;){if(1==c.nodeType)l(c);else if(3==c.nodeType)for(var a;(a=c.nextSibling)&&3==a.nodeType;){var d=a.nodeValue;null!=d&&d.length&&(c.nodeValue+=d);b.removeChild(a)}c=c.nextSibling}}var c={},v=null,y=/^\s*$/,w=/^\d+$/;c.DOM_VK_DELETE=8;c.DOM_VK_LEFT=37;c.DOM_VK_UP=38;c.DOM_VK_RIGHT=39;c.DOM_VK_DOWN=40;c.DOM_VK_ENTER=13;c.ELEMENT_NODE=1;c.ATTRIBUTE_NODE=2;c.TEXT_NODE=3;c.CDATA_SECTION_NODE=4;c.ENTITY_REFERENCE_NODE=5;c.ENTITY_NODE=6;c.PROCESSING_INSTRUCTION_NODE=
7;c.COMMENT_NODE=8;c.DOCUMENT_NODE=9;c.DOCUMENT_TYPE_NODE=10;c.DOCUMENT_FRAGMENT_NODE=11;c.NOTATION_NODE=12;c.CHARACTER_UNIT="character";c.WORD_UNIT="word";c.BREAK_ELEMENT="br";c.PARAGRAPH_ELEMENT="p";c.CONTENT_STUB_ELEMENTS="img hr iframe param link meta input frame col base area".split(" ");c.BLOCK_ELEMENTS="body p div pre ul ol li table tbody td th fieldset form blockquote dl dt dd dir center address h1 h2 h3 h4 h5 h6".split(" ");c.TEXT_CONTAINER_ELEMENTS="body p div pre span b strong i li td th blockquote dt dd center address h1 h2 h3 h4 h5 h6 ins del".split(" ");
c.STUB_ELEMENTS=c.CONTENT_STUB_ELEMENTS.slice();c.STUB_ELEMENTS.push(c.BREAK_ELEMENT);var D=c.CONTENT_STUB_ELEMENTS.join(", ");c.getKeyChar=function(b){return String.fromCharCode(b.which)};c.getClass=function(b,c,a){c||(c=document.body);b="."+b.split(" ").join(".");a&&(b=a+b);return h.makeArray(h(c).find(b))};c.getId=function(b,c){c||(c=document);return element=c.getElementById(b)};c.getTag=function(b,c){c||(c=document);return h.makeArray(h(c).find(b))};c.getElementWidth=function(b){return b.offsetWidth};
c.getElementHeight=function(b){return b.offsetHeight};c.getElementDimensions=function(b){return{width:c.getElementWidth(b),height:c.getElementHeight(b)}};c.empty=function(b){if(b)return h(b).empty()};c.remove=function(b){if(b)return h(b).remove()};c.prepend=function(b,c){h(b).prepend(c)};c.append=function(b,c){h(b).append(c)};c.insertBefore=function(b,c){h(b).before(c)};c.insertAfter=function(b,c){if(b&&c){var a=b.nextSibling,d=b.parentNode;return a?d.insertBefore(c,a):d.appendChild(c)}};c.getHtml=
function(b){return h(b).html()};c.setHtml=function(b,c){b&&h(b).html(c)};c.removeWhitespace=function(b){h(b).contents().filter(function(){return this.nodeType!=ice.dom.TEXT_NODE&&"UL"==this.nodeName||"OL"==this.nodeName?(c.removeWhitespace(this),!1):this.nodeType!=ice.dom.TEXT_NODE?!1:!/\S/.test(this.nodeValue)}).remove()};c.contents=function(b){return h.makeArray(h(b).contents())};c.extractContent=function(b){for(var c=document.createDocumentFragment(),a;a=b.firstChild;)c.appendChild(a);return c};
c.getNode=function(b,f){if(!b)return null;b=b.$||b;return b.nodeType!=c.TEXT_NODE&&c.is(b,f)?b:c.parents(b,f)[0]||null};c.getParents=function(b,c,a){b=h(b).parents(c);c=b.length;for(var d=[],e=0;e<c&&b[e]!==a;e++)d.push(b[e]);return d};c.hasBlockChildren=function(b){for(var f=b.childNodes.length,a=0;a<f;a++)if(b.childNodes[a].nodeType===c.ELEMENT_NODE&&!0===c.isBlockElement(b.childNodes[a]))return!0;return!1};c.removeTag=function(b,c){h(b).find(c).replaceWith(function(){return h(this).contents()});
return b};c.stripEnclosingTags=function(b,c){var a=h(b);a.find("*").not(c).replaceWith(function(){var a=h(),b;try{b=h(this),a=b.contents()}catch(c){}0===a.length&&b.remove();return a});return a[0]};c.getSiblings=function(b,c,a,d){if(!0===a)return"prev"===c?h(b).prevAll():h(b).nextAll();a=[];if("prev"===c)for(;b.previousSibling;){b=b.previousSibling;if(b===d)break;a.push(b)}else for(;b.nextSibling;){b=b.nextSibling;if(b===d)break;a.push(b)}return a};c.getNodeTextContent=function(b){return h(b).text()};
c.getNodeStubContent=function(b){return h(b).find(D)};c.hasNoTextOrStubContent=function(b){var f=c.getNodeTextContent(b);return n(f)?b.firstChild?0===h(b).find(D).length:!0:!1};c.isEmptyTextNode=function(b){return b&&c.TEXT_NODE===b.nodeType?0===b.length?!0:n(b.nodeValue):!1};c.getNodeCharacterLength=function(b){return c.getNodeTextContent(b).length+h(b).find(c.STUB_ELEMENTS.join(", ")).length};c.setNodeTextContent=function(b,c){return h(b).text(c)};c.getTagName=function(b){return b&&b.tagName&&b.tagName.toLowerCase()||
null};c.getIframeDocument=function(b){var c=null;b.contentDocument?c=b.contentDocument:b.contentWindow?c=b.contentWindow.document:b.document&&(c=b.document);return c};c.isBlockElement=function(b){return-1!=c.BLOCK_ELEMENTS.indexOf(b.nodeName.toLowerCase())};c.isStubElement=function(b){return-1!=c.STUB_ELEMENTS.indexOf(b.nodeName.toLowerCase())};c.removeBRFromChild=function(b){if(b&&b.hasChildNodes())for(var c=0;c<b.childNodes.length;c++){var a=b.childNodes[c];a&&ice.dom.BREAK_ELEMENT==ice.dom.getTagName(a)&&
a.parentNode.removeChild(a)}};c.isChildOf=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode===c)return!0;b=b.parentNode}}catch(a){}return!1};c.isChildOfTagName=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName&&b.parentNode.tagName.toLowerCase()===c)return b.parentNode;b=b.parentNode}}catch(a){}return!1};c.isChildOfTagNames=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName){tagName=b.parentNode.tagName.toLowerCase();for(var a=0;a<c.length;a++)if(tagName===
c[a])return b.parentNode}b=b.parentNode}}catch(d){}return null};c.isChildOfClassName=function(b,c){try{for(;b&&b.parentNode;){if(h(b.parentNode).hasClass(c))return b.parentNode;b=b.parentNode}}catch(a){}return null};c.cloneNode=function(b,c){void 0===c&&(c=!0);return h(b).clone(c)};c.bind=function(b,c,a){return h(b).bind(c,a)};c.unbind=function(b,c,a){return h(b).unbind(c,a)};c.attr=function(b,c,a){return a?h(b).attr(c,a):h(b).attr(c)};c.replaceWith=function(b,c){return h(b).replaceWith(c)};c.removeAttr=
function(b,c){h(b).removeAttr(c)};c.getElementsBetween=function(b,f){var a=[];if(b===f)return a;if(!0===c.isChildOf(f,b)){for(var d=b.childNodes.length,e=0;e<d&&b.childNodes[e]!==f;e++){if(!0===c.isChildOf(f,b.childNodes[e]))return c.arrayMerge(a,c.getElementsBetween(b.childNodes[e],f));a.push(b.childNodes[e])}return a}for(d=b.nextSibling;d;){if(!0===c.isChildOf(f,d))return a=c.arrayMerge(a,c.getElementsBetween(d,f));if(d===f)return a;a.push(d);d=d.nextSibling}for(var d=c.getParents(b),e=c.getParents(f),
d=c.arrayDiff(d,e,!0),e=d.length,g=0;g<e-1;g++)a=c.arrayMerge(a,c.getSiblings(d[g],"next"));return a=c.arrayMerge(a,c.getElementsBetween(d[d.length-1],f))};c.getCommonAncestor=function(b,f){for(var a=b;a;){if(!0===c.isChildOf(f,a))return a;a=a.parentNode}return null};c.getNextNode=function(b,f){if(b)for(;b.parentNode&&b!==f;){if(b.nextSibling){if(b.nextSibling.nodeType===c.TEXT_NODE&&0===b.nextSibling.length){b=b.nextSibling;continue}return c.getFirstChild(b.nextSibling)}b=b.parentNode}return null};
c.getNextContentNode=function(b,f){if(b)for(;b.parentNode&&b!==f;){if(b.nextSibling&&c.canContainTextElement(c.getBlockParent(b))){if(b.nextSibling.nodeType===c.TEXT_NODE&&0===b.nextSibling.length){b=b.nextSibling;continue}return b.nextSibling}if(b.nextElementSibling)return b.nextElementSibling;b=b.parentNode}return null};c.getPrevNode=function(b,f){if(b)for(;b.parentNode&&b!==f;){if(b.previousSibling){if(b.previousSibling.nodeType===c.TEXT_NODE&&0===b.previousSibling.length){b=b.previousSibling;
continue}return c.getLastChild(b.previousSibling)}b=b.parentNode}return null};c.getPrevContentNode=function(b,f){if(b)for(;b.parentNode&&b!==f;){if(b.previousSibling&&c.canContainTextElement(c.getBlockParent(b))){if(b.previousSibling.nodeType===c.TEXT_NODE&&0===b.previousSibling.length){b=b.previousSibling;continue}return b.previousSibling}if(b.previousElementSibling)return b.previousElementSibling;b=b.parentNode}return null};c.findPrevTextContainer=function(b,f){if(!b||b==f)return{node:f,offset:0};
if(b.parentNode&&c.isTextContainer(b.parentNode))return{node:b.parentNode,offset:c.getNodeIndex(b)};for(;b.previousSibling;){var a=g(b.previousSibling);if(a)return{node:a,offset:c.getNodeLength(a)};b=b.previousSibling}return c.findPrevTextContainer(b.parentNode&&b.parentNode.previousSibling,f)};c.findNextTextContainer=function(b,f){if(!b||b==f)return{node:f,offset:c.getNodeLength(f)};if(b.parentNode&&c.isTextContainer(b.parentNode))return{node:b.parentNode,offset:c.getNodeIndex(b)+1};for(;b.nextSibling;){var a=
r(b.nextSibling);if(a)return{node:a,offset:0};b=b.previousSibling}return c.findNextTextContainer(b.parentNode&&b.parentNode.nextSibling,f)};c.getNodeLength=function(b){return b?c.TEXT_NODE==b.nodeType?b.length:b.childNodes&&b.childNodes.length||0:0};c.isTextContainer=function(b){return b&&c.TEXT_NODE==b.nodeType||0<=c.TEXT_CONTAINER_ELEMENTS.indexOf((b.nodeName||"").toLowerCase())};c.getNodeIndex=function(b){for(var c=0;b=b.previousSibling;)++c;return c};c.canContainTextElement=function(b){return b&&
b.nodeName?-1!=c.TEXT_CONTAINER_ELEMENTS.lastIndexOf(b.nodeName.toLowerCase()):!1};c.getFirstChild=function(b){return b.firstChild?b.firstChild.nodeType===c.ELEMENT_NODE?c.getFirstChild(b.firstChild):b.firstChild:b};c.getLastChild=function(b){return b.lastChild?b.lastChild.nodeType===c.ELEMENT_NODE?c.getLastChild(b.lastChild):b.lastChild:b};c.removeEmptyNodes=function(b,f){for(var a=h(b).find(":empty"),d=a.length;0<d;)d--,!1===c.isStubElement(a[d])&&(f&&!1===f.call(this,a[d])||c.remove(a[d]))};c.create=
function(b){return h(b)[0]};c.find=function(b,c){return h(b).find(c)};c.children=function(b,c){return h(b).children(c)};c.parent=function(b,c){return h(b).parent(c)[0]};c.parents=function(b,c){return h(b).parents(c)};c.is=function(b,c){return h(b).is(c)};c.extend=function(b,c,a,d){return h.extend.apply(this,arguments)};c.walk=function(b,f,a){b&&(a||(a=0),!1!==f.call(this,b,a)&&(b.childNodes&&0<b.childNodes.length?c.walk(b.firstChild,f,a+1):b.nextSibling?c.walk(b.nextSibling,f,a):b.parentNode&&b.parentNode.nextSibling&&
c.walk(b.parentNode.nextSibling,f,a-1)))};c.revWalk=function(b,f){b&&!1!==f.call(this,b)&&(b.childNodes&&0<b.childNodes.length?c.walk(b.lastChild,f):b.previousSibling?c.walk(b.previousSibling,f):b.parentNode&&b.parentNode.previousSibling&&c.walk(b.parentNode.previousSibling,f))};c.setStyle=function(b,c,a){b&&h(b).css(c,a)};c.getStyle=function(b,c){return h(b).css(c)};c.hasClass=function(b,c){return h(b).hasClass(c)};c.addClass=function(b,c){h(b).addClass(c)};c.removeClass=function(b,c){h(b).removeClass(c)};
c.preventDefault=function(b){b.preventDefault();c.stopPropagation(b)};c.stopPropagation=function(b){b.stopPropagation()};c.each=function(b,c){h.each(b,function(a,b){c.call(this,a,b)})};c.foreach=function(b,c){var a,d;if(b instanceof Array||b instanceof NodeList||"undefined"!=typeof b.length&&"undefined"!=typeof b.item){d=b.length;for(var e=0;e<d&&(a=c.call(this,e,b[e]),!1!==a);e++);}else for(d in b)if(!0===b.hasOwnProperty(d)&&(a=c.call(this,d),!1===a))break};c.isBlank=function(b){return!b||y.test(b)};
c.isFn=function(b){return"function"===typeof b};c.isObj=function(b){return null!==b&&"object"===typeof b};c.isset=function(b){return"undefined"!==typeof b&&null!==b};c.isArray=function(b){return h.isArray(b)};c.isNumeric=function(b){return null!==b.match(w)};c.getUniqueId=function(){var b=(new Date).getTime(),c=Math.ceil(1E6*Math.random());return(b+""+c).substr(5,18).replace(/,/,"")};c.inArray=function(b,c){for(var a=c.length,d=0;d<a;d++)if(b===c[d])return!0;return!1};c.arrayDiff=function(b,f,a){var d=
b.length,e,g=[];for(e=0;e<d;e++)!1===c.inArray(b[e],f)&&g.push(b[e]);if(!0!==a)for(d=f.length,e=0;e<d;e++)!1===c.inArray(f[e],b)&&g.push(f[e]);return g};c.arrayMerge=function(b,c){var a=c.length,d;for(d=0;d<a;d++)b.push(c[d]);return b};c.stripTags=function(b,f){if("string"===typeof f){var a=h("\x3cdiv\x3e"+b+"\x3c/div\x3e");a.find("*").not(f).remove();return a.html()}for(var d=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),e=b;null!=(a=d.exec(b));)if(!1===c.isset(f)||
!0!==c.inArray(a[1],f))e=e.replace(a[0],"");return e};c.browser=function(){if(v)return h.extend({},v);var b,c,a=navigator.userAgent.toLowerCase();b=a.toLowerCase();c=/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||0>b.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];b=c[1]||"";c=c[2]||"0";var d={type:"unknown",version:0,msie:!1};b&&(d[b]=!0,d.version=c||0,d.type=b);d.chrome?d.webkit=!0:d.webkit&&
(d.safari=!0);d.webkit&&(d.type="webkit");d.firefox=1==/firefox/.test(a);d.msie||(d.msie=Boolean(/trident/.test(a)));v=d;return h.extend({},v)};c.getBrowserType=function(){if(null===this._browserType){for(var b=["msie","firefox","chrome","safari"],c=b.length,a=0;a<c;a++)if(!0===(new RegExp(b[a],"i")).test(navigator.userAgent))return this._browserType=b[a];this._browserType="other"}return this._browserType};c.getWebkitType=function(){return"webkit"!==c.browser().type?(console.log("Not a webkit!"),
!1):0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")?"safari":"chrome"};c.isBrowser=function(b){return c.browser().type===b};c.getBlockParent=function(b,f){if(!0===c.isBlockElement(b))return b;if(b)for(;b.parentNode;){b=b.parentNode;if(!0===c.isBlockElement(b))return b;if(b===f)break}return null};c.findNodeParent=function(b,f,a){if(b)for(;b.parentNode&&b!==a;){if(!0===c.is(b,f))return b;b=b.parentNode}return null};c.onBlockBoundary=function(b,f,a){if(!b||!f)return!1;b=c.isChildOfTagNames(b,
a)||c.is(b,a.join(", "))&&b||null;f=c.isChildOfTagNames(f,a)||c.is(f,a.join(", "))&&f||null;return b!==f};c.isOnBlockBoundary=function(b,f,a){if(!b||!f)return!1;b=c.getBlockParent(b,a)||c.isBlockElement(b,a)&&b||null;f=c.getBlockParent(f,a)||c.isBlockElement(f,a)&&f||null;return b!==f};c.mergeContainers=function(b,f){if(!b||!f)return!1;if(b.nodeType===c.TEXT_NODE||c.isStubElement(b))f.appendChild(b);else if(b.nodeType===c.ELEMENT_NODE){for(;b.firstChild;)f.appendChild(b.firstChild);c.remove(b)}return!0};
c.mergeBlockWithSibling=function(b,f,a){var d=a?h(f).next().get(0):h(f).prev().get(0);a?c.mergeContainers(d,f):c.mergeContainers(f,d);b.collapse(!0);return!0};c.date=function(b,f,a){if(null===f&&a&&(f=c.tsIso8601ToTimestamp(a),!f))return;f=new Date(f);b=b.split("");a=b.length;for(var d="",e=0;e<a;e++){var g="",h=b[e];switch(h){case "D":case "l":g="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ")[f.getDay()];"D"===h&&(g=g.substring(0,3));break;case "F":case "m":g=f.getMonth()+1;
10>g&&(g="0"+g);break;case "M":months="January February March April May June July August September October November December".split(" ");g=months[f.getMonth()];"M"===h&&(g=g.substring(0,3));break;case "d":g=f.getDate();break;case "S":g=c.getOrdinalSuffix(f.getDate());break;case "Y":g=f.getFullYear();break;case "y":g=f.getFullYear();g=g.toString().substring(2);break;case "H":g=f.getHours();break;case "h":g=f.getHours();0===g?g=12:12<g&&(g-=12);break;case "i":g=c.addNumberPadding(f.getMinutes());break;
case "a":g="am";12<=f.getHours()&&(g="pm");break;default:g=h}d+=g}return d};c.getOrdinalSuffix=function(b){var c="",c=b%100;if(4<=c&&20>=c)c="th";else switch(b%10){case 1:c="st";break;case 2:c="nd";break;case 3:c="rd";break;default:c="th"}return c};c.addNumberPadding=function(b){10>b&&(b="0"+b);return b};c.tsIso8601ToTimestamp=function(b){if(b=b.match(new RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/))){var c=
new Date;c.setDate(b[3]);c.setFullYear(b[1]);c.setMonth(b[2]-1);c.setHours(b[4]);c.setMinutes(b[5]);c.setSeconds(b[6]);var a=60*b[9];"+"===b[8]&&(a*=-1);a-=c.getTimezoneOffset();return c.getTime()+6E4*a}return null};c.normalizeNode=function(b,f){if(b)return c.browser().msie||!0===f||"function"!=typeof b.normalize?l(b):b.normalize()};this.dom=c}).call(this.ice,window.jQuery);
(function(){var h;h=function(h){this._selection=null;this.env=h;this._initializeRangeLibrary();this._getSelection()};h.prototype={_getSelection:function(){this._selection?this._selection.refresh():this._selection=this.env.frame?rangy.getSelection(this.env.frame):rangy.getSelection();return this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(h){try{return this._selection.refresh(),this._selection.getRangeAt(h)}catch(r){this._selection=null;try{return this._getSelection().getRangeAt(0)}catch(g){}}return null},
addRange:function(h){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(h);this._selection.ranges=[h]},_initializeRangeLibrary:function(){var h=this;rangy.init();rangy.config.checkSelectionRanges=!1;var r=function(g,h,c,n){if(0!==c){var r=g.collapsed;switch(h){case ice.dom.CHARACTER_UNIT:0<c?g.moveCharRight(n,c):g.moveCharLeft(n,-1*c)}r&&g.collapse(n)}};rangy.rangePrototype.moveStart=function(g,h){r(this,g,h,!0)};rangy.rangePrototype.moveEnd=function(g,h){r(this,
g,h,!1)};rangy.rangePrototype.setRange=function(g,h,c){g?this.setStart(h,c):this.setEnd(h,c)};rangy.rangePrototype.moveCharLeft=function(g,h){var c,n;g?(c=this.startContainer,n=this.startOffset):(c=this.endContainer,n=this.endOffset);if(c.nodeType===ice.dom.ELEMENT_NODE)if(c.hasChildNodes()&&0<n){c=c.childNodes[n-1];c=(n=this.getLastSelectableChild(c))?n:this.getPreviousTextNode(c);if(!c)return;n=c.data.length-h}else n=-1*h;else n-=h;if(0>n)for(;0>n;){c=this.getPreviousTextNode(c);if(!c)return;c.nodeType!==
ice.dom.ELEMENT_NODE&&(n+=c.data.length)}this.setRange(g,c,n)};rangy.rangePrototype.moveCharRight=function(g,h){var c,n;g?(c=this.startContainer,n=this.startOffset):(c=this.endContainer,n=this.endOffset);c.nodeType===ice.dom.ELEMENT_NODE?(c=(n=this.getNextTextNode(c.childNodes[Math.min(n,c.childNodes.length-1)]))?n:this.getNextTextNode(c),n=h):n+=h;if(c){var r=n-c.data.length;if(0<r){for(;0<r;){c=this.getNextContainer(c);if(!c)return;if(c.nodeType!==ice.dom.ELEMENT_NODE)if(c.data.length>=r)break;
else 0<c.data.length&&(r-=c.data.length)}n=r}this.setRange(g,c,n)}};rangy.rangePrototype.getNextContainer=function(g,h){if(!g)return null;for(h=h||[];g.nextSibling;)if(g=g.nextSibling,g.nodeType!==ice.dom.TEXT_NODE){var c=this.getFirstSelectableChild(g);if(null!==c)return c}else if(!0===this.isSelectable(g))return g;for(;g&&!g.nextSibling;)g=g.parentNode;if(!g)return null;g=g.nextSibling;if(!0===this.isSelectable(g))return g;!0===ice.dom.isBlockElement(g)&&h.push(g);c=this.getFirstSelectableChild(g);
return null!==c?c:this.getNextContainer(g,h)};rangy.rangePrototype.getPreviousContainer=function(g,h){if(!g)return null;for(h=h||[];g.previousSibling;)if(g=g.previousSibling,g.nodeType!==ice.dom.TEXT_NODE){if(!0===ice.dom.isStubElement(g))return g;var c=this.getLastSelectableChild(g);if(null!==c)return c}else if(!0===this.isSelectable(g))return g;for(;g&&!g.previousSibling;)g=g.parentNode;if(!g)return null;g=g.previousSibling;if(!0===this.isSelectable(g))return g;!0===ice.dom.isBlockElement(g)&&h.push(g);
c=this.getLastSelectableChild(g);return null!==c?c:this.getPreviousContainer(g,h)};rangy.rangePrototype.getNextTextNode=function(g){if(g.nodeType===ice.dom.ELEMENT_NODE&&g.firstChild){var h=this.getFirstSelectableChild(g);if(h)return h}return(g=this.getNextContainer(g))?g.nodeType===ice.dom.TEXT_NODE?g:this.getNextTextNode(g):null};rangy.rangePrototype.getPreviousTextNode=function(g,h){return(g=this.getPreviousContainer(g,h))?g.nodeType===ice.dom.TEXT_NODE?g:this.getPreviousTextNode(g,h):null};rangy.rangePrototype.getFirstSelectableChild=
function(g){if(!g)return null;if(g.nodeType===ice.dom.TEXT_NODE)return g;for(g=g.firstChild;g;){if(!0===this.isSelectable(g))return g;if(g.firstChild){var h=this.getFirstSelectableChild(g);if(null!==h)return h}g=g.nextSibling}return null};rangy.rangePrototype.getLastSelectableChild=function(g){if(!g)return null;if(g.nodeType==ice.dom.TEXT_NODE)return g;for(g=g.lastChild;g;){if(!0===this.isSelectable(g))return g;if(g.lastChild){var h=this.getLastSelectableChild(g);if(null!==h)return h}g=g.previousSibling}return null};
rangy.rangePrototype.isSelectable=function(g){return Boolean(g&&g.nodeType===ice.dom.TEXT_NODE&&0!==g.data.length)};rangy.rangePrototype.getHTMLContents=function(g){g||(g=this.cloneContents());var l=h.env.document.createElement("div");l.appendChild(g.cloneNode(!0));return l.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};this.Selection=h}).call(this.ice);
(function(){var h;h=function(h,r,g){this.env=h;this.element=h.element;this.selection=this.env.selection;g||this.removeBookmarks(this.element);h=r||this.selection.getRangeAt(0);r=h.cloneRange();var l=r.startContainer,c=r.startOffset,v;r.collapse(!1);g=this.env.document.createElement("span");g.style.display="none";ice.dom.setHtml(g,"\x26nbsp;");ice.dom.addClass(g,"iceBookmark iceBookmark_end");g.setAttribute("iceBookmark","end");r.insertNode(g);ice.dom.isChildOf(g,this.element)||this.element.appendChild(g);
r.setStart(l,c);r.collapse(!0);l=this.env.document.createElement("span");l.style.display="none";ice.dom.addClass(l,"iceBookmark iceBookmark_start");ice.dom.setHtml(l,"\x26nbsp;");l.setAttribute("iceBookmark","start");try{r.insertNode(l),l.previousSibling===g&&(v=l,l=g,g=v)}catch(y){ice.dom.insertBefore(g,l)}!1===ice.dom.isChildOf(l,this.element)&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,l):this.element.appendChild(l));g.previousSibling||(v=this.env.document.createTextNode(""),
ice.dom.insertBefore(g,v));l.nextSibling||(v=this.env.document.createTextNode(""),ice.dom.insertAfter(l,v));h.setStart(l.nextSibling,0);h.setEnd(g.previousSibling,g.previousSibling.length||0);this.start=l;this.end=g};h.prototype={selectBookmark:function(){var h=this.selection.getRangeAt(0),r=null,g=null,l=0,c=null,v=this.start&&this.start.parentNode;this.start.nextSibling===this.end||0===ice.dom.getElementsBetween(this.start,this.end).length?this.end.nextSibling?r=ice.dom.getFirstChild(this.end.nextSibling):
this.start.previousSibling?(r=ice.dom.getFirstChild(this.start.previousSibling),r.nodeType===ice.dom.TEXT_NODE&&(l=r.length)):(this.end.parentNode.appendChild(this.env.document.createTextNode("")),r=ice.dom.getFirstChild(this.end.nextSibling)):(this.start.nextSibling?r=ice.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(r=this.env.document.createTextNode(""),ice.dom.insertBefore(this.start,r)),r=ice.dom.getLastChild(this.start.previousSibling),l=r.length),this.end.previousSibling?
g=ice.dom.getLastChild(this.end.previousSibling):(g=ice.dom.getFirstChild(this.end.nextSibling||this.end),c=0));ice.dom.remove([this.start,this.end]);try{ice.dom.normalize(v)}catch(y){}null===g?(h.setEnd(r,l),h.collapse(!1)):(h.setStart(r,l),null===c&&(c=g.length||0),h.setEnd(g,c));try{this.selection.addRange(h)}catch(w){}},getBookmark:function(h,r){return ice.dom.getClass("iceBookmark_"+r,h)[0]},removeBookmarks:function(h){ice.dom.remove(ice.dom.getClass("iceBookmark",h,"span"))}};this.Bookmark=
h}).call(this.ice);var LITE={Events:{INIT:"lite:init",ACCEPT:"lite:accept",REJECT:"lite:reject",SHOW_HIDE:"lite:showHide",TRACKING:"lite:tracking",CHANGE:"lite:change",HOVER_IN:"lite:hover-in",HOVER_OUT:"lite:hover-out"},Commands:{TOGGLE_TRACKING:"lite-toggletracking",TOGGLE_SHOW:"lite-toggleshow",ACCEPT_ALL:"lite-acceptall",REJECT_ALL:"lite-rejectall",ACCEPT_ONE:"lite-acceptone",REJECT_ONE:"lite-rejectone",TOGGLE_TOOLTIPS:"lite-toggletooltips"}};